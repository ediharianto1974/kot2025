<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ† Kejohanan Olahraga SK Abang Gesa 2025 (Firebase)</title>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-auth.js"></script>
    <style>
        /* Gaya Asas */
        body { font-family: 'Arial', sans-serif; margin: 0; padding: 0; background-color: #f4f4f9; color: #333; }
        .container { max-width: 1200px; margin: 20px auto; padding: 20px; background-color: #fff; border-radius: 8px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); }
        h1, h2 { color: #004d40; text-align: center; }
        nav { background-color: #00796b; padding: 10px 0; border-radius: 6px 6px 0 0; display: flex; justify-content: center; }
        nav button { background: none; border: none; color: white; padding: 10px 20px; margin: 0 5px; cursor: pointer; font-size: 16px; transition: background-color 0.3s; border-radius: 4px; }
        nav button:hover, nav button.active { background-color: #004d40; }
        /* Gaya untuk Butang Admin (Akan dikawal oleh JS) */
        #nav-jana, #nav-keputusan { display: none; } 
        .page { display: none; padding: 20px 0; }
        .page.active { display: block; }

        /* Gaya Borang */
        form, .data-entry { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; padding: 20px; border: 1px solid #ccc; border-radius: 6px; margin-bottom: 20px; }
        .data-entry { grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); }
        label { font-weight: bold; margin-bottom: 5px; display: block; color: #004d40; }
        input[type="text"], input[type="number"], select, input[type="email"], input[type="password"] { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        
        /* Gaya untuk Checkbox Acara (BARU) */
        .acara-checkbox-group { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 5px; }
        .acara-checkbox-group label { font-weight: normal; display: inline-flex; align-items: center; margin-right: 15px; }
        .acara-checkbox-group input[type="checkbox"] { width: auto; margin-right: 5px; }

        button[type="submit"], .btn { background-color: #00796b; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; transition: background-color 0.3s; }
        button[type="submit"]:hover, .btn:hover { background-color: #004d40; }
        .btn-print { background-color: #00bcd4; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; transition: background-color 0.3s; margin-left: 10px; }
        .btn-print:hover { background-color: #00838f; }

        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.8); display: none; justify-content: center; align-items: center; z-index: 1000; font-size: 20px; font-weight: bold; color: #004d40; }

        /* Gaya Jadual */
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        th { background-color: #e0f2f1; color: #004d40; }
        tr:nth-child(even) { background-color: #f9f9f9; }
        /* Gaya Jadual Lompat Tinggi */
        #table-lompat-tinggi th { padding: 5px 2px; font-size: 0.8em; text-align: center; }
        #table-lompat-tinggi td input[type="text"] { width: 30px; padding: 2px; text-align: center; }


        /* Gaya Analisis / Keputusan */
        .results-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 20px; }
        .rumah-sukan-score { padding: 15px; border-radius: 6px; text-align: center; }
        .merah { background-color: #ffebee; border: 2px solid #e53935; color: #e53935; }
        .biru { background-color: #e3f2fd; border: 2px solid #2196f3; color: #2196f3; }
        .kuning { background-color: #fffde7; border: 2px solid #ffeb3b; color: #ffc107; }
        .score-title { font-size: 1.2em; font-weight: bold; margin-bottom: 5px; }
        .total-points { font-size: 2.5em; font-weight: bold; }
        .event-card { border: 1px solid #00796b; border-radius: 6px; padding: 15px; margin-bottom: 10px; background-color: #f0fdfc; }
        
        /* Gaya untuk Cetak: Sembunyikan navigasi dan butang pada cetakan */
        @media print {
            nav, button, input[type="text"], input[type="submit"], .data-entry div:last-child button, #filter-pendaftaran, #table-keputusan-disimpan, .print-hidden, h3 { display: none !important; }
            .container { box-shadow: none; margin: 0; padding: 0; }
            h1 { margin-top: 0; }
            
            /* Sembunyikan semua kecuali borang keputusan yang aktif di halaman keputusan */
            #keputusan > div.data-entry, #keputusan > h3 { display: none !important; }

            /* Tunjukkan elemen yang perlu dicetak sahaja */
            #table-jana-acara, #form-masuk-keputusan, #kep-tajuk, #analisis-keputusan-penuh { display: table !important; }
            
            /* Khas untuk Input Keputusan di Keputusan & Markah */
            #keputusan.active #form-masuk-keputusan { display: block !important; }
            #keputusan.active #kep-tajuk { display: block !important; }
            #keputusan.active h2 { display: block !important; }
        }
    </style>
</head>
<body>

<div class="loading-overlay" id="loading">Memuatkan Data...</div>

<div class="container">
    <h1>ğŸ† Kejohanan Olahraga Tahunan SK Abang Gesa 2025 (Firebase)</h1>
    <nav>
        <button onclick="showPage('daftar')" id="nav-daftar" class="active">ğŸ“ Daftar Acara</button>
        <button onclick="showPage('jana')" id="nav-jana">ğŸƒ Jana Acara & Lorong</button>
        <button onclick="showPage('keputusan')" id="nav-keputusan">ğŸ¥‡ Keputusan & Markah</button>
        <button onclick="showPage('analisis')" id="nav-analisis">ğŸ“Š Analisis Keseluruhan</button>
    </nav>

    <div id="login" class="page active">
        <h2>ğŸ”’ Log Masuk Admin</h2>
        <form id="form-login" style="max-width: 400px; margin: 20px auto; display: grid; grid-template-columns: 1fr; gap: 10px;">
            <div>
                <label for="login-email">Emel Admin:</label>
                <input type="email" id="login-email" required placeholder="admin@sekolah.edu.my">
            </div>
            <div>
                <label for="login-password">Kata Laluan:</label>
                <input type="password" id="login-password" required placeholder="*****">
            </div>
            <button type="submit">Log Masuk</button>
            <p id="login-status" style="color: red; text-align: center;"></p>
        </form>
        <p style="text-align: center;">Hanya Admin boleh mengakses bahagian Jana Acara dan Keputusan.</p>
    </div>

    <div id="daftar" class="page">
        <h2>ğŸ“ Daftar Peserta</h2>
        <form id="form-daftar-peserta">
            <div style="grid-column: 1 / -1;">
                <label>Acara (Maks. 3 Individu + 1 Berpasukan):</label>
                <div id="reg-acara-container" class="acara-checkbox-group">
                    </div>
            </div>
            <div><label for="reg-kategori">Kategori (Tahun):</label><select id="reg-kategori" required>
                <option value="Tahun 1">Tahun 1</option>
                <option value="Tahun 2">Tahun 2</option>
                <option value="Tahun 3">Tahun 3</option>
                <option value="Tahun 4">Tahun 4</option>
                <option value="Tahun 5">Tahun 5</option>
                <option value="Tahun 6">Tahun 6</option>
            </select></div>
            <div><label for="reg-jantina">Jantina:</label><select id="reg-jantina" required><option value="Lelaki">Lelaki</option><option value="Perempuan">Perempuan</option></select></div>
            <div><label for="reg-rumah">Rumah Sukan:</label><select id="reg-rumah" required><option value="Merah">Rumah Sukan Merah</option><option value="Biru">Rumah Sukan Biru</option><option value="Kuning">Rumah Sukan Kuning</option></select></div>
            
            <div id="div-nama-pasukan" style="display: none; grid-column: 1 / -1; border: 1px solid #00796b; padding: 10px; border-radius: 4px;">
                <p style="font-weight: bold; margin-top: 0;">Maklumat Pasukan (4x100m)</p>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div><label for="pasukan-no-badan">Nombor Badan Pasukan:</label><input type="text" id="pasukan-no-badan" placeholder="e.g., P4X01" required></div>
                    <div><label for="pasukan-nama1">Peserta 1:</label><input type="text" id="pasukan-nama1" class="nama-pasukan" required></div>
                    <div><label for="pasukan-nama2">Peserta 2:</label><input type="text" id="pasukan-nama2" class="nama-pasukan" required></div>
                    <div><label for="pasukan-nama3">Peserta 3:</label><input type="text" id="pasukan-nama3" class="nama-pasukan" required></div>
                    <div><label for="pasukan-nama4">Peserta 4:</label><input type="text" id="pasukan-nama4" class="nama-pasukan" required></div>
                </div>
            </div>

            <div id="div-nama-individu" style="grid-column: 1 / -1; display: grid; grid-template-columns: 3fr 1fr; gap: 10px;">
                <div>
                    <label for="reg-nama">Nama Peserta:</label>
                    <input type="text" id="reg-nama" placeholder="Nama Penuh Peserta" required>
                </div>
                <div>
                    <label for="reg-no-badan">Nombor Badan:</label>
                    <input type="text" id="reg-no-badan" placeholder="e.g., A123" required>
                </div>
            </div>
            
            <button type="submit" style="grid-column: 1 / -1;">â• Daftar Peserta</button>
        </form>

        <h3>Senarai Peserta Berdaftar</h3>
        <input type="text" id="filter-pendaftaran" onkeyup="filterPendaftaran()" placeholder="Cari mengikut Nama, Acara, Kategori, atau No. Badan..." style="width: 100%; margin-bottom: 15px; padding: 10px;">
        
        <table id="table-pendaftaran">
<thead><tr><th>Acara</th><th>Kategori</th><th>Jantina</th><th>Rumah Sukan</th><th>Peserta</th><th>No. Badan</th><th>Tindakan</th></tr></thead>
            <tbody></tbody>
        </table>
    </div>

    <div id="jana" class="page">
        <h2>ğŸƒ Jana Acara & Lorong</h2>
        <div class="data-entry">
            <div><label for="jana-acara">Pilih Acara untuk Dijana:</label><select id="jana-acara"></select></div>
            <div><label for="jana-kategori">Pilih Kategori:</label><select id="jana-kategori">
                <option value="Tahun 1">Tahun 1</option>
                <option value="Tahun 2">Tahun 2</option>
                <option value="Tahun 3">Tahun 3</option>
                <option value="Tahun 4">Tahun 4</option>
                <option value="Tahun 5">Tahun 5</option>
                <option value="Tahun 6">Tahun 6</option>
            </select></div>
            <div><label for="jana-jantina">Pilih Jantina:</label><select id="jana-jantina"><option value="Lelaki">Lelaki</option><option value="Perempuan">Perempuan</option></select></div>
            <div>
                <button onclick="janaAcara()">ğŸš€ Jana Acara & Lorong</button>
                <button class="btn-print" onclick="window.print()">ğŸ–¨ï¸ Cetak</button>
            </div>
        </div>
        
        <h3 id="jana-tajuk"></h3>
        <p id="jana-status"></p>
        <table id="table-jana-acara" style="display: none;">
            <thead><tr><th>Lorong/Giliran</th><th>Rumah Sukan</th><th>Peserta</th></tr></thead>
            <tbody></tbody>
        </table>
    </div>

    <div id="keputusan" class="page">
        <h2>ğŸ¥‡ Masukkan Keputusan & Mata</h2>
        <div class="data-entry">
            <div><label for="kep-acara">Pilih Acara:</label><select id="kep-acara"></select></div>
            <div><label for="kep-kategori">Pilih Kategori:</label><select id="kep-kategori">
                <option value="Tahun 1">Tahun 1</option>
                <option value="Tahun 2">Tahun 2</option>
                <option value="Tahun 3">Tahun 3</option>
                <option value="Tahun 4">Tahun 4</option>
                <option value="Tahun 5">Tahun 5</option>
                <option value="Tahun 6">Tahun 6</option>
            </select></div>
            <div><label for="kep-jantina">Pilih Jantina:</label><select id="kep-jantina"><option value="Lelaki">Lelaki</option><option value="Perempuan">Perempuan</option></select></div>
            <div>
                <button onclick="paparPesertaKeputusan()">ğŸ” Muatkan Peserta</button>
                <button class="btn-print" onclick="window.print()">ğŸ–¨ï¸ Cetak</button>
            </div>
        </div>

        <h3 id="kep-tajuk"></h3>
        
        <form id="form-masuk-keputusan" style="display: none; grid-template-columns: 1fr;">
            <div id="keputusan-input-container"></div>
            <button type="submit">âœ… Simpan Keputusan & Kira Mata</button>
        </form>

        <h3>Keputusan Disimpan Ringkas</h3>
        <table id="table-keputusan-disimpan">
             <thead><tr><th>Acara</th><th>Kategori</th><th>Jantina</th><th>Juara (6 M)</th><th>Kedua (4 M)</th><th>Ketiga (3 M)</th></tr></thead>
            <tbody></tbody>
        </table>
    </div>

    <div id="analisis" class="page">
        <h2>ğŸ“Š Analisis Keseluruhan Rumah Sukan</h2>
        <div class="results-grid">
            <div id="score-merah" class="rumah-sukan-score merah"><div class="score-title">Rumah Sukan Merah</div><div class="total-points">0</div></div>
            <div id="score-biru" class="rumah-sukan-score biru"><div class="score-title">Rumah Sukan Biru</div><div class="total-points">0</div></div>
            <div id="score-kuning" class="rumah-sukan-score kuning"><div class="score-title">Rumah Sukan Kuning</div><div class="total-points">0</div></div>
        </div>
        <div style="text-align: right; margin-top: 10px;">
             <button class="btn-print" onclick="window.print()">ğŸ–¨ï¸ Cetak</button>
        </div>
        
        <h3>Pecahan Markah Mengikut Acara</h3>
        <div id="pecahan-markah"></div>

        <hr>

        <h2>ğŸ“œ Keputusan Pertandingan Mengikut Acara</h2>
        <div id="analisis-keputusan-penuh">
            </div>
        
    </div>
</div>

<script>
    // ====================================================================
    // I. KONFIGURASI FIREBASE (SILA GANTI DENGAN MAKLUMAT ANDA)
    // ====================================================================
    const firebaseConfig = {
        apiKey: "AIzaSyCqK3mYKfkHE4N67qFNpFqg1nrCzOtCJqo",
        authDomain: "kot-sk-abang-gesa-2025.firebaseapp.com",
        databaseURL: "https://kot-sk-abang-gesa-2025-default-rtdb.asia-southeast1.firebasedatabase.app", 
        projectId: "kot-sk-abang-gesa-2025",
        storageBucket: "kot-sk-abang-gesa-2025.firebasestorage.app",
        messagingSenderId: "67901274927",
        appId: "1:67901274927:web:198aba9aaae160e7623fda"
    };

    // Inisialisasi Firebase
    if (firebaseConfig.apiKey.includes("GANTI_DENGAN_")) {
        alert("âš ï¸ SILA GANTI KONFIGURASI FIREBASE di Bahagian I. Data tidak akan disimpan!");
        document.getElementById('loading').textContent = "KESALAHAN: Sila masukkan konfigurasi Firebase.";
        document.getElementById('loading').style.display = 'flex';
    } else {
        firebase.initializeApp(firebaseConfig);
    }
    const db = firebase.database();
    const dbAuth = firebase.auth(); 
    
    // Rujukan kepada nod data utama
    const dbRefPendaftaran = db.ref('pendaftaran');
    const dbRefAcaraDijana = db.ref('acaraDijana');
    const dbRefKeputusan = db.ref('keputusan');
    
    // --- Data Model Lokal (Untuk Cache) ---
    let pendaftaran = [];
    let acaraDijana = {}; 
    let keputusan = [];
    let isAdmin = false; 

    // ====================================================================
    // II. DATA DAN UTILITIES
    // ====================================================================
    
    const ACARA_INDIVIDU = ["100 meter", "200 meter", "100 Meter Berpagar", "Lompat Jauh", "Lompat Tinggi", "Lontar Peluru"]; 
    const ACARA_BERPASUKAN = ["4x100 meter"];
    const ACARA_SEMUA = [...ACARA_INDIVIDU, ...ACARA_BERPASUKAN];
    const KATEGORI = ["Tahun 1", "Tahun 2", "Tahun 3", "Tahun 4", "Tahun 5", "Tahun 6"]; 
    const LORONG = { "100 meter": 6, "200 meter": 3, "4x100 meter": 3, "100 Meter Berpagar": 6 };
    const MATA = { 
        "1": 6,  // Johan
        "2": 4,  // Kedua
        "3": 3,  // Ketiga
        "4": 1,  // Keempat
        "5": 1,  // Kelima
        "6": 1   // Keenam
    };

    function showLoading() { document.getElementById('loading').style.display = 'flex'; }
    function hideLoading() { document.getElementById('loading').style.display = 'none'; }
    function isAcaraPadang(acara) { return ["Lompat Jauh", "Lompat Tinggi", "Lontar Peluru"].includes(acara); }
    function isAcaraBerpasukan(acara) { return ACARA_BERPASUKAN.includes(acara); }
    
    function isAcaraAvailable(acara, kategori) {
        const tahun1_3 = ["Tahun 1", "Tahun 2", "Tahun 3"];
        const tahun4_6 = ["Tahun 4", "Tahun 5", "Tahun 6"];
        
        // Logik sedia ada...
        if (tahun1_3.includes(kategori)) { 
            if (!["100 meter", "4x100 meter"].includes(acara)) {
                 // Tambah acara padang untuk T3-T6 sahaja. T1 & T2 hanya 100m dan 4x100m
                 if (isAcaraPadang(acara)) return false; 
            }
        }
        
        if (acara === "100 Meter Berpagar") {
            return tahun4_6.includes(kategori);
        }
        
        return true; 
    }
    
    function getUniqueKey(acara, kategori, jantina) { 
        return acara.replace(/\s/g, '_') + '|' + kategori.replace(/\s/g, '_') + '|' + jantina; 
    }
    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
    }

    const toUpperCase = (event) => {
        event.target.value = event.target.value.toUpperCase();
    };

    // ====================================================================
    // III. FIREBASE LISTENERS (MUAT DATA REAL-TIME)
    // ====================================================================

    dbRefPendaftaran.on('value', (snapshot) => {
        showLoading();
        const data = snapshot.val();
        pendaftaran = [];
        if (data) {
            Object.keys(data).forEach(key => pendaftaran.push(data[key]));
        }
        paparkanPendaftaran();
        if (document.getElementById('filter-pendaftaran')) {
             filterPendaftaran();
        }
    });

    dbRefAcaraDijana.on('value', (snapshot) => {
        acaraDijana = snapshot.val() || {};
    });

    dbRefKeputusan.on('value', (snapshot) => {
        showLoading();
        const data = snapshot.val();
        keputusan = [];
        if (data) {
            Object.keys(data).forEach(key => keputusan.push(data[key]));
        }
        paparkanKeputusanDisimpan();
        if (document.getElementById('analisis').classList.contains('active')) {
             kiraAnalisis();
             paparkanKeputusanPenuh(); 
        }
        hideLoading();
    });

    // ====================================================================
    // IV. PENGURUSAN UI DAN AUTHENTICATION
    // ====================================================================
    
    function showPage(pageId) {
        if (['jana', 'keputusan'].includes(pageId) && !isAdmin) {
            alert("Akses Ditolak. Sila log masuk sebagai Admin untuk melihat halaman ini.");
            pageId = 'login'; 
        } else if (pageId === 'login' && isAdmin) {
            pageId = 'daftar'; 
        }

        document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
        document.getElementById(pageId).classList.add('active');
        document.querySelectorAll('nav button').forEach(btn => btn.classList.remove('active'));
        
        const navButton = document.getElementById(`nav-${pageId}`);
        if(navButton) navButton.classList.add('active');

        if (pageId === 'analisis') {
            kiraAnalisis();
            paparkanKeputusanPenuh();
        } else if (pageId === 'daftar' || pageId === 'jana' || pageId === 'keputusan') {
            muatkanAcaraPilihan();
        }
    }
    
    function toggleNavButtons(loggedIn) {
        const navJana = document.getElementById('nav-jana');
        const navKeputusan = document.getElementById('nav-keputusan');
        const navAnalisis = document.getElementById('nav-analisis');
        
        navJana.style.display = loggedIn ? 'inline-block' : 'none';
        navKeputusan.style.display = loggedIn ? 'inline-block' : 'none';
        
        let btnLogout = document.getElementById('nav-logout');
        if (loggedIn && !btnLogout) {
             btnLogout = document.createElement('button');
             btnLogout.id = 'nav-logout';
             btnLogout.textContent = 'ğŸšª Log Keluar';
             btnLogout.onclick = logoutAdmin;
             document.querySelector('nav').insertBefore(btnLogout, navAnalisis.nextSibling);

        } else if (!loggedIn && btnLogout) {
             btnLogout.remove();
        }
    }
    
    function logoutAdmin() {
        dbAuth.signOut().then(() => {
            isAdmin = false;
            toggleNavButtons(false);
            showPage('login'); 
        });
    }

    // --- Handler Log Masuk ---
    document.getElementById('form-login').addEventListener('submit', function(e) {
        e.preventDefault();
        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-password').value;
        const statusMsg = document.getElementById('login-status');
        statusMsg.textContent = 'Memproses...';
        showLoading();

        dbAuth.signInWithEmailAndPassword(email, password)
            .then((userCredential) => {
                statusMsg.textContent = 'Log masuk berjaya!';
            })
            .catch((error) => {
                console.error(error);
                statusMsg.textContent = 'Ralat log masuk: Emel atau Kata Laluan salah.';
                hideLoading();
            });
    });

    // --- Semak Status Auth Semasa Muat Halaman (Wajib) ---
    dbAuth.onAuthStateChanged((user) => {
        if (user) {
            isAdmin = true;
            toggleNavButtons(true);
            const currentPage = document.querySelector('.page.active');
            if (!currentPage || currentPage.id === 'login') {
                 showPage('daftar'); 
            }
            paparkanPendaftaran(); 
        } else {
            isAdmin = false;
            toggleNavButtons(false);
            const currentPage = document.querySelector('.page.active');
            if (currentPage && ['jana', 'keputusan'].includes(currentPage.id)) {
                 showPage('daftar'); 
            }
            if (!currentPage) {
                 showPage('daftar'); 
            }
            paparkanPendaftaran(); 
        }
        hideLoading();
    });

    // ====================================================================
    // V. FUNGSI APLIKASI UTAMA
    // ====================================================================

    // PENGUBAHSUAIAN: Muatkan Acara sebagai Checkbox dan Validate Kategori
    function muatkanAcaraPilihan() {
        const selects = ['jana-acara', 'kep-acara']; 
        
        // 1. Handle Checkbox Pendaftaran
        const container = document.getElementById('reg-acara-container');
        const selectedKategori = document.getElementById('reg-kategori').value;
        container.innerHTML = '';
        
        ACARA_SEMUA.forEach(acara => {
            if (isAcaraAvailable(acara, selectedKategori)) {
                const isPasukan = isAcaraBerpasukan(acara);
                
                const label = document.createElement('label');
                label.htmlFor = `acara-${acara.replace(/\s/g, '-')}`;
                
                const input = document.createElement('input');
                input.type = 'checkbox';
                input.name = 'reg-acara';
                input.value = acara;
                input.id = `acara-${acara.replace(/\s/g, '-')}`;
                input.dataset.type = isPasukan ? 'berpasukan' : 'individu';
                
                input.addEventListener('change', checkAcaraLimit);
                
                label.appendChild(input);
                label.appendChild(document.createTextNode(acara + (isPasukan ? ' (Pasukan)' : ' (Individu)')));
                container.appendChild(label);
            }
        });
        
        // 2. Handle Dropdown Jana & Keputusan
        selects.forEach(selectId => {
            const selectElement = document.getElementById(selectId);
            if (!selectElement) return;

            const currentValue = selectElement.value;
            let selectedKat; 
            
            if (selectId.startsWith('jana')) {
                selectedKat = document.getElementById('jana-kategori').value;
            } else if (selectId.startsWith('kep')) {
                selectedKat = document.getElementById('kep-kategori').value;
            }
            
            selectElement.innerHTML = '';
            let firstAcara = '';
            ACARA_SEMUA.forEach(acara => {
                if (isAcaraAvailable(acara, selectedKat)) {
                    const option = document.createElement('option');
                    option.value = acara;
                    option.textContent = acara;
                    selectElement.appendChild(option);
                    if (!firstAcara) firstAcara = acara;
                }
            });
            selectElement.value = currentValue || firstAcara; 
        });

        toggleNamaInput();
    }
    
    // FUNGSI BARU: Semak Had Acara
    function checkAcaraLimit() {
        const checkboxes = document.querySelectorAll('input[name="reg-acara"]:checked');
        let countIndividu = 0;
        let countPasukan = 0;

        checkboxes.forEach(cb => {
            if (cb.dataset.type === 'individu') {
                countIndividu++;
            } else if (cb.dataset.type === 'berpasukan') {
                countPasukan++;
            }
        });

        if (countIndividu > 3) {
            alert("âš ï¸ Had Maksimum 3 Acara Individu telah dicapai! Sila nyahpilih satu acara individu.");
            this.checked = false; 
            countIndividu--;
        }
        if (countPasukan > 1) {
            alert("âš ï¸ Had Maksimum 1 Acara Berpasukan (4x100m) telah dicapai!");
            this.checked = false;
            countPasukan--;
        }
        
        toggleNamaInput();
    }


    // PENGUBAHSUAIAN: Hanya tampilkan borang nama yang relevan
    function toggleNamaInput() {
        const checkboxes = document.querySelectorAll('input[name="reg-acara"]:checked');
        const isPasukanDipilih = Array.from(checkboxes).some(cb => cb.value === '4x100 meter');
        const isIndividuDipilih = Array.from(checkboxes).some(cb => !isAcaraBerpasukan(cb.value));

        const divIndividu = document.getElementById('div-nama-individu');
        const inputNama = document.getElementById('reg-nama');
        const inputNoBadan = document.getElementById('reg-no-badan'); 

        const divPasukan = document.getElementById('div-nama-pasukan');
        const inputPasukanNama = document.querySelectorAll('.nama-pasukan');
        const inputPasukanNoBadan = document.getElementById('pasukan-no-badan'); 
        const submitButton = document.getElementById('form-daftar-peserta').querySelector('button[type="submit"]');

        // Pendaftaran Individu
        divIndividu.style.display = isIndividuDipilih ? 'grid' : 'none';
        inputNama.required = isIndividuDipilih;
        inputNoBadan.required = isIndividuDipilih;
        
        // Pendaftaran Pasukan (4x100m)
        divPasukan.style.display = isPasukanDipilih ? 'block' : 'none';
        inputPasukanNama.forEach(input => input.required = isPasukanDipilih);
        inputPasukanNoBadan.required = isPasukanDipilih;
        
        // Enable/Disable Submit Button
        submitButton.disabled = !(isIndividuDipilih || isPasukanDipilih);
        
        // PENTING: Attach toUpperCase listeners
        inputNama.addEventListener('input', toUpperCase);
        inputNoBadan.addEventListener('input', toUpperCase);
        inputPasukanNama.forEach(input => input.addEventListener('input', toUpperCase));
        inputPasukanNoBadan.addEventListener('input', toUpperCase);

    }

    // --- EVENT LISTENERS UNTUK CATEGORY CHANGE ---
    document.getElementById('reg-kategori').onchange = muatkanAcaraPilihan;
    document.getElementById('jana-kategori').onchange = muatkanAcaraPilihan; 
    document.getElementById('kep-kategori').onchange = muatkanAcaraPilihan; 
    document.getElementById('reg-jantina').onchange = muatkanAcaraPilihan; 


    // PENGUBAHSUAIAN: Handle Pendaftaran Berbilang Acara
    document.getElementById('form-daftar-peserta').addEventListener('submit', function(e) {
        e.preventDefault();

        const kategori = document.getElementById('reg-kategori').value;
        const jantina = document.getElementById('reg-jantina').value;
        const rumah = document.getElementById('reg-rumah').value;
        const checkboxes = Array.from(document.querySelectorAll('input[name="reg-acara"]:checked')).map(cb => cb.value);

        if (checkboxes.length === 0) {
            alert("Sila pilih sekurang-kurangnya satu acara untuk pendaftaran.");
            return;
        }

        const namaPesertaIndividu = document.getElementById('reg-nama').value.trim();
        const noBadanIndividu = document.getElementById('reg-no-badan').value.trim().toUpperCase();
        
        const namaPasukan = Array.from(document.querySelectorAll('.nama-pasukan')).map(input => input.value.trim());
        const noBadanPasukan = document.getElementById('pasukan-no-badan').value.trim().toUpperCase();
        const acaraPasukan = '4x100 meter';

        let pendaftaranBatch = [];
        let hasError = false;

        // 1. Pendaftaran Acara Individu
        checkboxes.filter(a => !isAcaraBerpasukan(a)).forEach(acara => {
            if (!namaPesertaIndividu || !noBadanIndividu) {
                alert(`Sila lengkapkan Nama dan No. Badan untuk acara individu: ${acara}`);
                hasError = true; return;
            }
            if (pendaftaran.some(p => p.noBadan === noBadanIndividu && p.acara === acara && p.kategori === kategori)) { 
                alert(`Peserta dengan No. Badan ${noBadanIndividu} sudah didaftar untuk ${acara} ${kategori} ${jantina}. Pendaftaran dibatalkan.`);
                hasError = true; return;
            }
            if (pendaftaran.filter(p => p.noBadan === noBadanIndividu && !isAcaraBerpasukan(p.acara)).length >= 3) {
                 // Check limit semasa pendaftaran
                 const acaraDipilihSekarang = pendaftaranBatch.filter(p => p.noBadan === noBadanIndividu && !isAcaraBerpasukan(p.acara)).map(p => p.acara);
                 if (!acaraDipilihSekarang.includes(acara)) { // Elak double check
                     alert(`âš ï¸ Peserta ${namaPesertaIndividu} sudah mencapai had 3 acara individu.`);
                     hasError = true; return;
                 }
            }
            
            const firebaseKey = dbRefPendaftaran.push().key; 
            pendaftaranBatch.push({
                id: firebaseKey, acara, kategori, jantina, rumah, 
                peserta: namaPesertaIndividu, noBadan: noBadanIndividu
            });
        });

        // 2. Pendaftaran Acara Berpasukan
        if (checkboxes.includes(acaraPasukan)) {
            if (namaPasukan.length !== 4 || !noBadanPasukan) {
                alert('Sila lengkapkan Nama 4 Peserta dan No. Badan Pasukan untuk 4x100 meter.');
                hasError = true; return;
            }
            if (pendaftaran.some(p => p.acara === acaraPasukan && p.kategori === kategori && p.jantina === jantina && p.rumah === rumah)) {
                alert(`Rumah Sukan ${rumah} sudah didaftarkan untuk ${acaraPasukan} ${kategori} ${jantina}. Pendaftaran dibatalkan.`);
                hasError = true; return;
            }
            
            const firebaseKey = dbRefPendaftaran.push().key; 
            pendaftaranBatch.push({
                id: firebaseKey, acara: acaraPasukan, kategori, jantina, rumah, 
                peserta: namaPasukan.join(', '), noBadan: noBadanPasukan 
            });
        }
        
        if (hasError || pendaftaranBatch.length === 0) {
            if (!hasError) alert("Tiada pendaftaran baru yang sah untuk disimpan.");
            return;
        }
        
        showLoading();
        let updates = {};
        pendaftaranBatch.forEach(item => {
            updates[`/${item.id}`] = item;
        });

        dbRefPendaftaran.update(updates)
            .then(() => {
                alert(`${pendaftaranBatch.length} pendaftaran berjaya disimpan ke Firebase!`);
                e.target.reset();
                muatkanAcaraPilihan(); 
                hideLoading();
            })
            .catch(error => {
                console.error("Ralat pendaftaran:", error);
                alert('Gagal mendaftar. Lihat konsol untuk ralat.');
                hideLoading();
            });
    });

function paparkanPendaftaran() {
        const tbody = document.getElementById('table-pendaftaran').getElementsByTagName('tbody')[0];
        tbody.innerHTML = '';
        
        // PENGUBAHSUAIAN: Susun senarai pendaftaran mengikut Kategori > Jantina > Rumah Sukan > Nama Peserta
        const pendaftaranTersusun = [...pendaftaran].sort((a, b) => {
            const kategoriA = KATEGORI.indexOf(a.kategori);
            const kategoriB = KATEGORI.indexOf(b.kategori);
            
            // 1. Susun mengikut Kategori (Tahun)
            if (kategoriA !== kategoriB) {
                return kategoriA - kategoriB;
            }

            // 2. Susun mengikut Jantina
            if (a.jantina < b.jantina) return -1;
            if (a.jantina > b.jantina) return 1;

            // 3. Susun mengikut Rumah Sukan (Alphabetical, contoh: Biru sebelum Merah)
            if (a.rumah < b.rumah) return -1;
            if (a.rumah > b.rumah) return 1;

            // 4. Susun mengikut Nama Peserta
            return a.peserta.localeCompare(b.peserta);
        });


        pendaftaranTersusun.forEach(p => {
            const row = tbody.insertRow();
            row.dataset.acara = p.acara.toLowerCase();
            row.dataset.kategori = p.kategori.toLowerCase();
            row.dataset.jantina = p.jantina.toLowerCase();
            row.dataset.rumah = p.rumah.toLowerCase();
            row.dataset.peserta = p.peserta.toLowerCase();
            row.dataset.nobadan = (p.noBadan || '').toLowerCase();
            
            row.insertCell().textContent = p.acara;
            row.insertCell().textContent = p.kategori;
            row.insertCell().textContent = p.jantina;
            row.insertCell().textContent = p.rumah;
            row.insertCell().textContent = p.peserta;
            row.insertCell().textContent = p.noBadan || '-'; 

            const cellTindakan = row.insertCell();
            if (isAdmin) {
                const btnPadam = document.createElement('button');
                btnPadam.textContent = 'âŒ Padam';
                btnPadam.className = 'btn'; 
                btnPadam.style.backgroundColor = '#d32f2f'; 
                btnPadam.style.padding = '5px 10px';
                btnPadam.style.fontSize = '0.8em';
                btnPadam.onclick = () => padamPeserta(p.id, p.peserta); 
                cellTindakan.appendChild(btnPadam);
            } else {
                cellTindakan.textContent = 'N/A';
            }
        });
        filterPendaftaran();
    }

    function filterPendaftaran() {
        const input = document.getElementById('filter-pendaftaran');
        if (!input) return;

        const filter = input.value.toUpperCase();
        const table = document.getElementById('table-pendaftaran');
        const tr = table.getElementsByTagName('tbody')[0].getElementsByTagName('tr');

        for (let i = 0; i < tr.length; i++) {
            let rowMatches = false;
            if (
                tr[i].dataset.acara.toUpperCase().indexOf(filter) > -1 ||
                tr[i].dataset.kategori.toUpperCase().indexOf(filter) > -1 ||
                tr[i].dataset.peserta.toUpperCase().indexOf(filter) > -1 ||
                tr[i].dataset.nobadan.toUpperCase().indexOf(filter) > -1 ||
                tr[i].dataset.rumah.toUpperCase().indexOf(filter) > -1
            ) {
                rowMatches = true;
            }

            if (rowMatches) {
                tr[i].style.display = "";
            } else {
                tr[i].style.display = "none";
            }
        }
    }

    function padamPeserta(pesertaId, namaPeserta) {
        if (!isAdmin) return alert("Akses Ditolak. Hanya Admin boleh memadam data.");

        if (confirm(`Adakah anda pasti mahu memadam peserta "${namaPeserta}"? Tindakan ini tidak boleh diundur.`)) {
            showLoading();
            dbRefPendaftaran.child(pesertaId).remove()
                .then(() => {
                    alert(`Peserta "${namaPeserta}" berjaya dipadam dari Firebase.`);
                })
                .catch(error => {
                    console.error("Ralat memadam peserta:", error);
                    alert('Gagal memadam peserta. Lihat konsol untuk ralat.');
                })
                .finally(() => {
                    hideLoading();
                });
        }
    }

    // --- Halaman Jana Acara (Firebase Write) ---
    function janaAcara() {
        if (!isAdmin) return alert("Akses Ditolak. Hanya Admin boleh menjana acara.");
        const acara = document.getElementById('jana-acara').value;
        const kategori = document.getElementById('jana-kategori').value;
        const jantina = document.getElementById('jana-jantina').value;
        const key = getUniqueKey(acara, kategori, jantina);

        if (!isAcaraAvailable(acara, kategori)) {
            document.getElementById('jana-status').textContent = `âš ï¸ Acara ${acara} tidak ditawarkan untuk ${kategori}.`;
            document.getElementById('table-jana-acara').style.display = 'none';
            document.getElementById('jana-tajuk').textContent = '';
            return;
        }

        const pesertaAcara = pendaftaran.filter(p => p.acara === acara && p.kategori === kategori && p.jantina === jantina);
        document.getElementById('jana-tajuk').textContent = `${acara} ${kategori} ${jantina}`;

        if (pesertaAcara.length === 0) {
            document.getElementById('jana-status').textContent = 'âŒ Tiada peserta didaftarkan untuk acara ini.';
            document.getElementById('table-jana-acara').style.display = 'none';
            return;
        }

        const isPadang = isAcaraPadang(acara);
        let maxSlot = isPadang ? pesertaAcara.length : LORONG[acara] || 6; 
        
        let slots = pesertaAcara.map((p, index) => ({ ...p, slot: isPadang ? (index + 1) : 0 }));
        shuffleArray(slots);

        if (!isPadang) {
            slots = slots.slice(0, maxSlot);
            slots.forEach((p, index) => p.slot = index + 1);
            shuffleArray(slots); 
        } else {
             slots.forEach((p, index) => p.slot = index + 1);
        }

        dbRefAcaraDijana.child(key).set(slots)
            .then(() => {
                 document.getElementById('jana-status').textContent = `âœ… ${slots.length} peserta telah dijana untuk lorong/giliran dan disimpan ke Firebase.`;
                 paparkanJanaAcara(slots);
            })
             .catch(error => {
                console.error("Ralat Jana Acara:", error);
                alert('Gagal menjana acara. Lihat konsol untuk ralat.');
            });
    }
    
    function paparkanJanaAcara(slots) {
        const tbody = document.getElementById('table-jana-acara').getElementsByTagName('tbody')[0];
        tbody.innerHTML = '';
        slots.sort((a, b) => a.slot - b.slot).forEach(p => {
            const row = tbody.insertRow();
            row.insertCell().textContent = p.slot;
            row.insertCell().textContent = p.rumah;
            row.insertCell().textContent = p.peserta;
        });
        document.getElementById('table-jana-acara').style.display = 'table';
    }

    // --- Halaman Keputusan (Firebase Read/Write) ---
    async function paparPesertaKeputusan() {
        if (!isAdmin) return alert("Akses Ditolak. Hanya Admin boleh memasukkan keputusan.");
        const acara = document.getElementById('kep-acara').value;
        const kategori = document.getElementById('kep-kategori').value;
        const jantina = document.getElementById('kep-jantina').value;
        const key = getUniqueKey(acara, kategori, jantina);
        const container = document.getElementById('keputusan-input-container');

        if (!isAcaraAvailable(acara, kategori)) {
             alert(`Acara ${acara} tidak ditawarkan untuk ${kategori}.`);
             document.getElementById('form-masuk-keputusan').style.display = 'none';
             document.getElementById('kep-tajuk').textContent = '';
             container.innerHTML = '';
             return;
        }

        const pesertaDijana = acaraDijana[key];
        document.getElementById('kep-tajuk').textContent = `Input Keputusan: ${acara} ${kategori} ${jantina}`;
        document.getElementById('form-masuk-keputusan').style.display = 'none';
        container.innerHTML = '';
        
        if (!pesertaDijana || pesertaDijana.length === 0) {
            alert('Sila Jana Acara & Lorong di Halaman "Jana Acara & Lorong" dahulu.');
            return;
        }
        
        // Muat keputusan sedia ada
        const resultExisting = keputusan.find(k => k.key === key);
        
        // PENGUBAHSUAIAN UTAMA: Render borang mengikut jenis acara
        if (acara === "Lompat Jauh" || acara === "Lontar Peluru") {
            renderBorangPadangBiasa(acara, pesertaDijana, resultExisting);
        } else if (acara === "Lompat Tinggi") {
            renderBorangLompatTinggi(acara, pesertaDijana, resultExisting);
        } else {
            renderBorangLarian(acara, pesertaDijana, resultExisting);
        }

        document.getElementById('form-masuk-keputusan').style.display = 'block';
    }
    
    // FUNGSI BARU: Render Borang Larian/Padang Standard
    function renderBorangLarian(acara, pesertaDijana, resultExisting) {
        const container = document.getElementById('keputusan-input-container');
        const unit = isAcaraPadang(acara) ? 'meter (m)' : 'saat (s)';
        
        let html = `
            <table id="table-masuk-keputusan">
                <thead><tr><th>Rumah Sukan</th><th>Peserta</th><th>Keputusan (<span id="unit-keputusan">${unit}</span>)</th><th>Kedudukan (1 - 6)</th></tr></thead>
                <tbody>
        `;
        
        pesertaDijana.sort((a, b) => a.slot - b.slot).forEach((p, index) => {
             const existing = resultExisting ? resultExisting.results.find(r => r.id === p.id) : {};
             const keputusanVal = existing.keputusan || '';
             const kedudukanVal = existing.kedudukan || '';
             
             html += `
                <tr data-id="${p.id}" data-rumah="${p.rumah}" data-key="${resultExisting ? resultExisting.key : ''}">
                    <td>${p.rumah}</td>
                    <td>${p.peserta}</td>
                    <td><input type="number" step="any" name="keputusan-${index}" value="${keputusanVal}" required></td>
                    <td>
                        <select name="kedudukan-${index}">
                            <option value="">-</option>
                            <option value="1" ${kedudukanVal === 1 ? 'selected' : ''}>1 (6 M)</option>
                            <option value="2" ${kedudukanVal === 2 ? 'selected' : ''}>2 (4 M)</option>
                            <option value="3" ${kedudukanVal === 3 ? 'selected' : ''}>3 (3 M)</option>
                            <option value="4" ${kedudukanVal === 4 ? 'selected' : ''}>4 (1 M)</option>
                            <option value="5" ${kedudukanVal === 5 ? 'selected' : ''}>5 (1 M)</option>
                            <option value="6" ${kedudukanVal === 6 ? 'selected' : ''}>6 (1 M)</option>
                        </select>
                    </td>
                </tr>
             `;
        });
        
        html += `</tbody></table>`;
        container.innerHTML = html;
    }
    
    // FUNGSI BARU: Render Borang Lompat Jauh/Lontar Peluru
    function renderBorangPadangBiasa(acara, pesertaDijana, resultExisting) {
        const container = document.getElementById('keputusan-input-container');
        const unit = acara === "Lontar Peluru" ? 'kg' : 'm';
        
        let html = `
            <table id="table-padang-biasa">
                <thead><tr>
                    <th>Rumah Sukan</th>
                    <th>Peserta</th>
                    <th>P1 (m)</th>
                    <th>P2 (m)</th>
                    <th>P3 (m)</th>
                    <th>PB (m)</th>
                    <th>Kedudukan (1 - 6)</th>
                </tr></thead>
                <tbody>
        `;
        
        pesertaDijana.forEach((p, index) => {
             const existing = resultExisting ? resultExisting.results.find(r => r.id === p.id) : {};
             const percubaan = existing.percubaan || {};
             const pb = existing.keputusan || ''; // PB disimpan dalam field 'keputusan'
             const kedudukanVal = existing.kedudukan || '';
             
             html += `
                <tr data-id="${p.id}" data-rumah="${p.rumah}" data-key="${resultExisting ? resultExisting.key : ''}">
                    <td>${p.rumah}</td>
                    <td>${p.peserta}</td>
                    <td><input type="number" step="any" name="p1-${index}" value="${percubaan.p1 || ''}" style="width: 50px;"></td>
                    <td><input type="number" step="any" name="p2-${index}" value="${percubaan.p2 || ''}" style="width: 50px;"></td>
                    <td><input type="number" step="any" name="p3-${index}" value="${percubaan.p3 || ''}" style="width: 50px;"></td>
                    <td><input type="number" step="any" name="pb-${index}" value="${pb}" required style="width: 60px;"></td>
                    <td>
                        <select name="kedudukan-${index}">
                            <option value="">-</option>
                            <option value="1" ${kedudukanVal === 1 ? 'selected' : ''}>1 (6 M)</option>
                            <option value="2" ${kedudukanVal === 2 ? 'selected' : ''}>2 (4 M)</option>
                            <option value="3" ${kedudukanVal === 3 ? 'selected' : ''}>3 (3 M)</option>
                            <option value="4" ${kedudukanVal === 4 ? 'selected' : ''}>4 (1 M)</option>
                            <option value="5" ${kedudukanVal === 5 ? 'selected' : ''}>5 (1 M)</option>
                            <option value="6" ${kedudukanVal === 6 ? 'selected' : ''}>6 (1 M)</option>
                        </select>
                    </td>
                </tr>
             `;
        });
        
        html += `</tbody></table>`;
        container.innerHTML = html;
    }

    // FUNGSI BARU: Render Borang Lompat Tinggi (Kompleks)
    function renderBorangLompatTinggi(acara, pesertaDijana, resultExisting) {
        const container = document.getElementById('keputusan-input-container');
        // Ketinggian ditetapkan secara hardcode untuk demo/kemudahan
        const KETINGGIAN = ["1.00", "1.10", "1.20", "1.30", "1.35", "1.40"]; 
        const totalAttempts = KETINGGIAN.length * 3;

        // Header Baris 1
        let htmlHeader1 = `
            <tr>
                <th rowspan="2">Rumah Sukan</th>
                <th rowspan="2">Peserta</th>
                <th colspan="${totalAttempts}">Percubaan Ketinggian (Catat 'O' untuk Lulus, 'X' untuk Gagal)</th>
                <th rowspan="2">PB (m)</th>
                <th rowspan="2">Kedudukan (1 - 6)</th>
            </tr>
            <tr>
        `;
        // Header Baris 2
        let htmlHeader2 = '';
        KETINGGIAN.forEach((h, hIndex) => {
            htmlHeader1 += `<th colspan="3">${h} m</th>`;
            for(let i=1; i<=3; i++) {
                htmlHeader2 += `<th>${i}</th>`;
            }
        });
        htmlHeader1 += `</tr>`;
        
        let htmlBody = '';
        pesertaDijana.forEach((p, index) => {
             const existing = resultExisting ? resultExisting.results.find(r => r.id === p.id) : {};
             const percubaan = existing.percubaan || {}; // Simpan sebagai 'h1_1', 'h1_2', 'h1_3', 'h2_1', dsb.
             const pb = existing.keputusan || ''; 
             const kedudukanVal = existing.kedudukan || '';
             
             let attemptsHtml = '';
             KETINGGIAN.forEach((h, hIndex) => {
                 for(let i=1; i<=3; i++) {
                    const fieldName = `h${hIndex+1}_${i}`;
                    const val = percubaan[fieldName] || '';
                    attemptsHtml += `
                        <td><input type="text" name="${fieldName}-${index}" value="${val.toUpperCase()}" 
                            maxlength="1" oninput="this.value = this.value.toUpperCase();"></td>
                    `;
                 }
             });
             
             htmlBody += `
                <tr data-id="${p.id}" data-rumah="${p.rumah}" data-key="${resultExisting ? resultExisting.key : ''}">
                    <td>${p.rumah}</td>
                    <td>${p.peserta}</td>
                    ${attemptsHtml}
                    <td><input type="number" step="any" name="pb-${index}" value="${pb}" required style="width: 60px;"></td>
                    <td>
                        <select name="kedudukan-${index}">
                            <option value="">-</option>
                            <option value="1" ${kedudukanVal === 1 ? 'selected' : ''}>1 (6 M)</option>
                            <option value="2" ${kedudukanVal === 2 ? 'selected' : ''}>2 (4 M)</option>
                            <option value="3" ${kedudukanVal === 3 ? 'selected' : ''}>3 (3 M)</option>
                            <option value="4" ${kedudukanVal === 4 ? 'selected' : ''}>4 (1 M)</option>
                            <option value="5" ${kedudukanVal === 5 ? 'selected' : ''}>5 (1 M)</option>
                            <option value="6" ${kedudukanVal === 6 ? 'selected' : ''}>6 (1 M)</option>
                        </select>
                    </td>
                </tr>
             `;
        });
        
        container.innerHTML = `
            <table id="table-lompat-tinggi" style="width: auto;">
                <thead>${htmlHeader1} ${htmlHeader2}</thead>
                <tbody>${htmlBody}</tbody>
            </table>
        `;
    }

    // PENGUBAHSUAIAN: Logik Simpan Keputusan (Handle Semua Jenis Acara)
    document.getElementById('form-masuk-keputusan').addEventListener('submit', function(e) {
        if (!isAdmin) return alert("Akses Ditolak. Hanya Admin boleh menyimpan keputusan.");
        e.preventDefault();
        
        const acara = document.getElementById('kep-acara').value;
        const tbody = document.getElementById('keputusan-input-container').querySelector('tbody');
        const rows = Array.from(tbody.rows);
        if (rows.length === 0) return;

        const key = rows[0].dataset.key || getUniqueKey(acara, document.getElementById('kep-kategori').value, document.getElementById('kep-jantina').value);
        const [kAcara, kategori, jantina] = key.split('|').map(s => s.replace(/_/g, ' ')); 

        let results = [];
        let kedudukanUsed = [];
        let hasError = false;

        rows.forEach((row, index) => {
            const rumah = row.dataset.rumah;
            const peserta = row.cells[1].textContent;
            const id = row.dataset.id; 
            const kedudukanVal = row.querySelector(`select[name="kedudukan-${index}"]`).value;
            
            let keputusanVal;
            let percubaan = {};

            if (acara === "Lompat Jauh" || acara === "Lontar Peluru" || acara === "Lompat Tinggi") {
                // Acara Padang: Keputusan utama diambil dari PB
                const pbInput = row.querySelector(`input[name="pb-${index}"]`);
                keputusanVal = parseFloat(pbInput.value);
                
                if (isNaN(keputusanVal) || keputusanVal <= 0) {
                     alert(`Sila masukkan Keputusan Terbaik (PB) yang sah untuk peserta ${peserta} (${acara}).`);
                     hasError = true; return;
                }
                
                if (acara === "Lompat Jauh" || acara === "Lontar Peluru") {
                    percubaan.p1 = parseFloat(row.querySelector(`input[name="p1-${index}"]`).value) || 0;
                    percubaan.p2 = parseFloat(row.querySelector(`input[name="p2-${index}"]`).value) || 0;
                    percubaan.p3 = parseFloat(row.querySelector(`input[name="p3-${index}"]`).value) || 0;
                } else if (acara === "Lompat Tinggi") {
                     // Lompat Tinggi - Simpan semua percubaan
                     const inputs = row.querySelectorAll('input[type="text"]');
                     inputs.forEach(input => {
                         const name = input.name.split('-')[0];
                         percubaan[name] = input.value.toUpperCase();
                     });
                }

            } else {
                // Acara Larian Standard
                const keputusanInput = row.querySelector(`input[name="keputusan-${index}"]`);
                keputusanVal = parseFloat(keputusanInput.value);
                if (isNaN(keputusanVal) || keputusanVal <= 0) {
                     alert(`Sila masukkan Keputusan/Masa yang sah untuk peserta ${peserta}.`);
                     hasError = true; return;
                }
            }
            
            if (kedudukanVal) {
                if (kedudukanUsed.includes(kedudukanVal)) {
                    alert(`Kedudukan ${kedudukanVal} telah diberikan lebih daripada sekali. Sila betulkan.`);
                    hasError = true; return;
                }
                kedudukanUsed.push(kedudukanVal);
            }

            results.push({
                id, rumah, peserta, 
                keputusan: keputusanVal, // Untuk larian atau PB untuk padang
                percubaan: acara === "Lompat Jauh" || acara === "Lontar Peluru" || acara === "Lompat Tinggi" ? percubaan : undefined,
                kedudukan: kedudukanVal ? parseInt(kedudukanVal) : 0,
                mata: kedudukanVal ? MATA[kedudukanVal] : 0,
            });
        });

        if (hasError) return;
        
        const resultData = {
            key, acara: kAcara, kategori, jantina,
            results: results.sort((a, b) => a.kedudukan - b.kedudukan)
        };
        
        dbRefKeputusan.child(key).set(resultData)
            .then(() => {
                alert('Keputusan dan mata telah dikira dan disimpan ke Firebase!');
                document.getElementById('form-masuk-keputusan').style.display = 'none';
                document.getElementById('kep-tajuk').textContent = '';
                document.getElementById('keputusan-input-container').innerHTML = '';
            })
            .catch(error => {
                console.error("Ralat Simpan Keputusan:", error);
                alert('Gagal menyimpan keputusan. Lihat konsol untuk ralat.');
            });
    });

    function paparkanKeputusanDisimpan() {
        const tbody = document.getElementById('table-keputusan-disimpan').getElementsByTagName('tbody')[0];
        tbody.innerHTML = '';
        
        keputusan.forEach(k => {
            const row = tbody.insertRow();
            row.insertCell().textContent = k.acara;
            row.insertCell().textContent = k.kategori;
            row.insertCell().textContent = k.jantina;
            
            const juara = k.results.find(r => r.kedudukan === 1);
            const kedua = k.results.find(r => r.kedudukan === 2);
            const ketiga = k.results.find(r => r.kedudukan === 3);

            row.insertCell().textContent = juara ? `${juara.rumah} (${juara.peserta.substring(0, 10)}...)` : '-';
            row.insertCell().textContent = kedua ? `${kedua.rumah} (${kedua.peserta.substring(0, 10)}...)` : '-';
            row.insertCell().textContent = ketiga ? `${ketiga.rumah} (${ketiga.peserta.substring(0, 10)}...)` : '-';
        });
    }

    // FUNGSI BARU: PAPARKAN KEPUTUSAN PENUH
    function paparkanKeputusanPenuh() {
        const container = document.getElementById('analisis-keputusan-penuh');
        container.innerHTML = '';
        
        const keputusanSorted = [...keputusan].sort((a, b) => {
            if (a.acara !== b.acara) return a.acara.localeCompare(b.acara);
            if (a.kategori !== b.kategori) return a.kategori.localeCompare(b.kategori);
            return a.jantina.localeCompare(b.jantina);
        });

        keputusanSorted.forEach(k => {
            const eventDiv = document.createElement('div');
            eventDiv.className = 'event-card'; 
            eventDiv.style.marginBottom = '20px';
            eventDiv.style.padding = '15px';
            
            const unit = isAcaraPadang(k.acara) ? 'm' : 's';
            let html = `<h4>${k.acara} - ${k.kategori} ${k.jantina}</h4>`;
            
            const resultsSorted = k.results.filter(r => r.kedudukan > 0).sort((a, b) => a.kedudukan - b.kedudukan);
            const totalPeserta = k.results.length; 
            const pesertaYangRekod = resultsSorted.length; 

            if (pesertaYangRekod === 0) {
                 html += '<p>Tiada keputusan direkodkan.</p>';
            } else {
                 html += `
                    <table style="width: 100%; font-size: 0.9em; margin-top: 10px;">
                    <thead><tr>
                        <th>Kedudukan</th>
                        <th>Rumah Sukan</th>
                        <th>Peserta</th>
                        <th>Keputusan (${unit})</th>
                        <th>Mata</th>
                    </tr></thead>
                    <tbody>
                 `;
                 
                 const resultsToDisplay = (totalPeserta <= 3) 
                     ? resultsSorted.filter(r => r.kedudukan <= 3)
                     : resultsSorted; 

                 resultsToDisplay.forEach(r => {
                     const rumahClass = r.rumah.toLowerCase();
                     const keputusanPaparan = r.keputusan ? (isAcaraPadang(k.acara) ? r.keputusan.toFixed(2) : r.keputusan.toFixed(2)) : '-';

                     html += `
                        <tr>
                            <td>${r.kedudukan}</td>
                            <td><span class="${rumahClass}" style="padding: 2px 5px; border-radius: 3px;">${r.rumah}</span></td>
                            <td>${r.peserta}</td>
                            <td>${keputusanPaparan}</td>
                            <td>${r.mata}</td>
                        </tr>
                     `;
                 });
                 
                 html += '</tbody></table>';
            }
            
            eventDiv.innerHTML = html;
            container.appendChild(eventDiv);
        });
    }

    function kiraAnalisis() {
        let markahRumah = { "Merah": 0, "Biru": 0, "Kuning": 0 };
        let pecahanAcara = {}; 

        keputusan.forEach(k => {
            const key = k.key;
            pecahanAcara[key] = {
                Merah: 0, Biru: 0, Kuning: 0,
                acara: k.acara, kategori: k.kategori, jantina: k.jantina
            };

            k.results.forEach(r => {
                if (r.kedudukan >= 1 && r.kedudukan <= 6) { 
                    markahRumah[r.rumah] += r.mata;
                    pecahanAcara[key][r.rumah] += r.mata;
                }
            });
        });

        document.getElementById('score-merah').querySelector('.total-points').textContent = markahRumah.Merah;
        document.getElementById('score-biru').querySelector('.total-points').textContent = markahRumah.Biru;
        document.getElementById('score-kuning').querySelector('.total-points').textContent = markahRumah.Kuning;

        const pecahanDiv = document.getElementById('pecahan-markah');
        pecahanDiv.innerHTML = '';

        const keysSorted = Object.keys(pecahanAcara).sort();

        keysSorted.forEach(key => {
            const data = pecahanAcara[key];
            const eventDiv = document.createElement('div');
            eventDiv.className = 'event-card';
            eventDiv.innerHTML = `
                <h4>${data.acara} - ${data.kategori} ${data.jantina}</h4>
                <p>
                    <span class="merah" style="padding: 2px 5px; border-radius: 3px;">Merah: <b>${data.Merah}</b> mata</span> |
                    <span class="biru" style="padding: 2px 5px; border-radius: 3px;">Biru: <b>${data.Biru}</b> mata</span> |
                    <span class="kuning" style="padding: 2px 5px; border-radius: 3px;">Kuning: <b>${data.Kuning}</b> mata</span>
                </p>
            `;
            pecahanDiv.appendChild(eventDiv);
        });
    }

    // --- Inisialisasi Aplikasi ---
    document.addEventListener('DOMContentLoaded', () => {
        // ...
    });

</script>

</body>
</html>

