<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üèÜ Kejohanan Olahraga SK Abang Gesa 2025 (Firebase)</title>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-auth.js"></script>
    <style>
        /* Gaya Asas */
        body { font-family: 'Arial', sans-serif; margin: 0; padding: 0; background-color: #f4f4f9; color: #333; }
        .container { max-width: 1200px; margin: 20px auto; padding: 20px; background-color: #fff; border-radius: 8px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); }
        h1, h2 { color: #004d40; text-align: center; }
        nav { background-color: #00796b; padding: 10px 0; border-radius: 6px 6px 0 0; display: flex; justify-content: center; }
        nav button { background: none; border: none; color: white; padding: 10px 20px; margin: 0 5px; cursor: pointer; font-size: 1em; transition: background-color 0.3s; }
        nav button:hover, nav button.active { background-color: #004d40; border-radius: 4px; }
        .page { display: none; padding-top: 20px; }
        .page.active { display: block; }
        
        /* Gaya Borang & Jadual */
        form { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; background-color: #f9f9f9; padding: 20px; border-radius: 6px; margin-bottom: 20px; }
        label { font-weight: bold; margin-bottom: 5px; display: block; }
        input[type="text"], input[type="number"], select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        .form-group { grid-column: span 1; }
        .full-width { grid-column: span 2; }
        form button[type="submit"] { background-color: #00796b; color: white; padding: 12px 20px; border: none; border-radius: 4px; cursor: pointer; font-size: 1.1em; transition: background-color 0.3s; margin-top: 10px; grid-column: span 2; }
        form button[type="submit"]:hover { background-color: #004d40; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; color: #333; }
        .btn { padding: 8px 15px; border: none; border-radius: 4px; cursor: pointer; color: white; transition: opacity 0.3s; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }

        /* Gaya Khusus Rumah Sukan */
        .rumah-sukan-score { text-align: center; padding: 15px; border-radius: 6px; color: white; font-weight: bold; min-width: 150px; }
        .merah { background-color: #d32f2f; }
        .biru { background-color: #1976d2; }
        .kuning { background-color: #fbc02d; color: #333; }
        .total-points { font-size: 2em; display: block; margin-top: 5px; }
        .event-card { border: 1px solid #ccc; padding: 10px; margin-bottom: 10px; border-radius: 4px; background-color: #fff; }

        /* Loading Overlay */
        #loading {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.8);
            display: none; justify-content: center; align-items: center; z-index: 1000;
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1); border-left-color: #00796b; border-radius: 50%;
            width: 40px; height: 40px; animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Gaya untuk Input Acara Berpasukan */
        #div-nama-pasukan { display: none; margin-top: 10px; }
        .nama-pasukan-group { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        
        /* Gaya Checkbox */
        #reg-acara-checkbox { display: flex; flex-wrap: wrap; gap: 10px; padding: 10px; border: 1px solid #ccc; border-radius: 4px; }
        #reg-acara-checkbox label { display: flex; align-items: center; font-weight: normal; margin-bottom: 0; }
        #reg-acara-checkbox input { width: auto; margin-right: 5px; }

    </style>
</head>
<body>
    <div id="loading">
        <div class="spinner"></div>
    </div>
    <div class="container">
        <h1>üèÜ Kejohanan Olahraga SK Abang Gesa 2025</h1>
        <nav>
            <button id="nav-daftar" class="active" onclick="showPage('daftar')">üìù Daftar Peserta</button>
            <button id="nav-analisis" onclick="showPage('analisis')">üìä Analisis Keputusan</button>
            <button id="nav-jana" onclick="showPage('jana')">üìã Jana Acara & Lorong</button>
            <button id="nav-keputusan" onclick="showPage('keputusan')">üèÖ Masuk Keputusan</button>
            <button id="nav-login" onclick="showPage('login')">üîë Log Masuk Admin</button>
            <button id="nav-logout" onclick="logoutAdmin()" style="background-color: #d32f2f; display: none;">üö™ Log Keluar</button>
        </nav>

        <div class="page" id="login">
            <h2>Log Masuk Admin</h2>
            <form id="form-login" style="grid-template-columns: 1fr; max-width: 400px; margin: 20px auto;">
                <div class="form-group">
                    <label for="login-email">Emel Admin:</label>
                    <input type="text" id="login-email" required>
                </div>
                <div class="form-group">
                    <label for="login-password">Kata Laluan:</label>
                    <input type="password" id="login-password" required>
                </div>
                <button type="submit">Log Masuk</button>
                <p id="login-status" style="text-align: center; grid-column: span 1;"></p>
            </form>
        </div>
        
        <div class="page active" id="daftar">
            <h2>Pendaftaran Peserta / Pasukan</h2>
            <form id="form-daftar-peserta">
                <div class="form-group">
                    <label for="reg-rumah">Rumah Sukan:</label>
                    <select id="reg-rumah" required>
                        <option value="Merah">Merah</option>
                        <option value="Biru">Biru</option>
                        <option value="Kuning">Kuning</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="reg-kategori">Kategori (Tahun):</label>
                    <select id="reg-kategori" required>
                        <option value="Tahun 1">Tahun 1</option>
                        <option value="Tahun 2">Tahun 2</option>
                        <option value="Tahun 3">Tahun 3</option>
                        <option value="Tahun 4">Tahun 4</option>
                        <option value="Tahun 5">Tahun 5</option>
                        <option value="Tahun 6">Tahun 6</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="reg-jantina">Jantina:</label>
                    <select id="reg-jantina" required>
                        <option value="Lelaki">Lelaki</option>
                        <option value="Perempuan">Perempuan</option>
                    </select>
                </div>
                <div class="full-width">
                    <label>Pilihan Acara (Maks. 3 Individu + 1 Pasukan):</label>
                    <div id="reg-acara-checkbox">
                        </div>
                </div>

                <div id="div-nama-individu" class="full-width">
                    <label for="reg-nama">Nama Peserta (Individu):</label>
                    <input type="text" id="reg-nama" required oninput="toUpperCase(event)">
                    <label for="reg-no-badan" style="margin-top: 10px;">No. Badan (Individu):</label>
                    <input type="text" id="reg-no-badan" required oninput="toUpperCase(event)">
                </div>

                <div id="div-nama-pasukan" class="full-width">
                    <label>Nama 4 Peserta (Untuk 4x100m sahaja):</label>
                    <div class="nama-pasukan-group">
                        <input type="text" class="nama-pasukan" placeholder="Peserta 1" required>
                        <input type="text" class="nama-pasukan" placeholder="Peserta 2" required>
                        <input type="text" class="nama-pasukan" placeholder="Peserta 3" required>
                        <input type="text" class="nama-pasukan" placeholder="Peserta 4" required>
                    </div>
                </div>

                <button type="submit">Daftar Peserta / Pasukan</button>
            </form>

            <h3>Senarai Pendaftaran Peserta</h3>
            <div class="printable-table-area">
                <button onclick="printPage('table-pendaftaran')" class="btn" style="background-color: #00796b; margin-bottom: 10px;">
                    üñ®Ô∏è Cetak Senarai Pendaftaran
                </button>
                <table id="table-pendaftaran">
                    <thead>
                        <tr><th>Acara</th><th>Kategori</th><th>Jantina</th><th>Rumah</th><th>Peserta</th><th>No. Badan</th><th>Tindakan</th></tr>
                    </thead>
                    <tbody>
                        </tbody>
                </table>
            </div>
        </div>
        
        <div class="page" id="jana">
            <h2>Jana Acara / Lorong / Giliran</h2>
            <form onsubmit="event.preventDefault(); janaAcara();">
                <div class="form-group">
                    <label for="jana-acara">Acara:</label>
                    <select id="jana-acara" required></select>
                </div>
                <div class="form-group">
                    <label for="jana-kategori">Kategori:</label>
                    <select id="jana-kategori" required>
                        <option value="Tahun 1">Tahun 1</option>
                        <option value="Tahun 2">Tahun 2</option>
                        <option value="Tahun 3">Tahun 3</option>
                        <option value="Tahun 4">Tahun 4</option>
                        <option value="Tahun 5">Tahun 5</option>
                        <option value="Tahun 6">Tahun 6</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="jana-jantina">Jantina:</label>
                    <select id="jana-jantina" required>
                        <option value="Lelaki">Lelaki</option>
                        <option value="Perempuan">Perempuan</option>
                    </select>
                </div>
                <button type="submit">‚ñ∂Ô∏è Jana Acara & Susunan</button>
            </form>

            <h3 id="jana-tajuk"></h3>
            <div class="printable-area">
                <button onclick="printPage('jana')" class="btn" style="background-color: #00796b; margin-bottom: 10px; display: none;" id="btn-jana-print">
                    üñ®Ô∏è Cetak Senarai Lorong / Giliran
                </button>
                <table id="table-jana-acara" style="display: none;">
                    <thead><tr></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <div class="page" id="keputusan">
            <h2>Masuk Keputusan & Kira Mata</h2>
            <form onsubmit="event.preventDefault(); paparPesertaKeputusan();" style="margin-bottom: 30px;">
                <div class="form-group">
                    <label for="kep-acara">Acara:</label>
                    <select id="kep-acara" required></select>
                </div>
                <div class="form-group">
                    <label for="kep-kategori">Kategori:</label>
                    <select id="kep-kategori" required>
                        <option value="Tahun 1">Tahun 1</option>
                        <option value="Tahun 2">Tahun 2</option>
                        <option value="Tahun 3">Tahun 3</option>
                        <option value="Tahun 4">Tahun 4</option>
                        <option value="Tahun 5">Tahun 5</option>
                        <option value="Tahun 6">Tahun 6</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="kep-jantina">Jantina:</label>
                    <select id="kep-jantina" required>
                        <option value="Lelaki">Lelaki</option>
                        <option value="Perempuan">Perempuan</option>
                    </select>
                </div>
                <button type="submit">‚ñ∂Ô∏è Muatkan Peserta</button>
            </form>
            
            <h3 id="kep-tajuk"></h3>
            <form id="form-masuk-keputusan" style="display: none; grid-template-columns: 1fr;">
                <button type="button" onclick="printPage('table-masuk-keputusan')" class="btn" style="background-color: #00796b; margin-bottom: 10px;">
                    üñ®Ô∏è Cetak Senarai Peserta / Lorong
                </button>
                <table id="table-masuk-keputusan">
                    <thead><tr><th>Rumah Sukan</th><th>Peserta</th><th>Keputusan (<span id="unit-keputusan-balapan"></span>)</th><th>Kedudukan (1 - 6)</th></tr></thead>
                    <tbody></tbody>
                </table>
                <button type="submit">‚úÖ Simpan Keputusan & Kira Mata</button>
            </form>

            <h3 style="margin-top: 50px;">Keputusan Disimpan (Rekod Penuh)</h3>
            <div class="printable-table-area">
                <button onclick="printPage('keputusan-disimpan')" class="btn" style="background-color: #004d40; margin-bottom: 10px;">
                    üñ®Ô∏è Cetak Jadual Keputusan Disimpan
                </button>
                <table id="table-keputusan-disimpan">
                    <thead>
                        <tr><th>Acara</th><th>Kategori</th><th>Jantina</th><th>Johan</th><th>Kedua</th><th>Ketiga</th></tr>
                    </thead>
                    <tbody>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="page" id="analisis">
            <h2>Analisis Keputusan & Markah</h2>
            <div class="printable-area">
                <button onclick="printPage('analisis')" class="btn" style="background-color: #00796b; margin-bottom: 20px;">
                    üñ®Ô∏è Cetak Keseluruhan Analisis & Markah
                </button>
                <div style="display: flex; justify-content: space-around; margin-bottom: 30px;">
                    <div id="score-merah" class="rumah-sukan-score merah">
                        Rumah Merah<span class="total-points">0</span>
                    </div>
                    <div id="score-biru" class="rumah-sukan-score biru">
                        Rumah Biru<span class="total-points">0</span>
                    </div>
                    <div id="score-kuning" class="rumah-sukan-score kuning">
                        Rumah Kuning<span class="total-points">0</span>
                    </div>
                </div>

                <div style="margin-bottom: 30px;">
                    <h3>Rekod Pemenang Acara (Kedudukan 1-3)</h3>
                    <table id="table-keputusan-pemenang-analisis">
                        <thead>
                            <tr><th>Acara</th><th>Kategori</th><th>Jantina</th><th>Johan</th><th>Kedua</th><th>Ketiga</th></tr>
                        </thead>
                        <tbody>
                            </tbody>
                    </table>
                </div>

                <div>
                    <h3>Pecahan Markah Mengikut Acara</h3>
                    <div id="pecahan-markah">
                        </div>
                </div>
            </div>
        </div>

    </div>

<script>
    // ====================================================================
    // I. KONFIGURASI FIREBASE (SILA GANTI DENGAN MAKLUMAT ANDA)
    // ====================================================================
    const firebaseConfig = {
        // ‚ö†Ô∏è SILA GANTI konfigurasi ini dengan maklumat projek Firebase anda sendiri!
        apiKey: "AIzaSyCqK3mYKfkHE4N67qFNpFqg1nrCzOtCJqo",
        authDomain: "kot-sk-abang-gesa-2025.firebaseapp.com",
        databaseURL: "https://kot-sk-abang-gesa-2025-default-rtdb.asia-southeast1.firebasedatabase.app", 
        projectId: "kot-sk-abang-gesa-2025",
        storageBucket: "kot-sk-abang-gesa-2025.firebasestorage.app",
        messagingSenderId: "67901274927",
        appId: "1:67901274927:web:198aba9aaae160e7623fda"
    };

    // Inisialisasi Firebase
    if (firebaseConfig.apiKey.includes("GANTI_DENGAN_")) {
        // Biarkan kosong jika anda tidak menggunakan Firebase
        // Anda boleh padam bahagian ini jika anda sudah meletakkan config yang betul
    } else {
        firebase.initializeApp(firebaseConfig);
    }
    const db = firebase.database();
    const dbAuth = firebase.auth(); 
    
    // Rujukan kepada nod data utama
    const dbRefPendaftaran = db.ref('pendaftaran');
    const dbRefAcaraDijana = db.ref('acaraDijana');
    const dbRefKeputusan = db.ref('keputusan');
    
    // --- Data Model Lokal (Untuk Cache) ---
    let pendaftaran = [];
    let acaraDijana = {}; 
    let keputusan = [];
    let isAdmin = false; 

    // ====================================================================
    // II. DATA DAN UTILITIES
    // ====================================================================
    
    const ACARA_INDIVIDU = ["100 meter", "200 meter", "100 Meter Berpagar", "Lompat Jauh", "Lompat Tinggi", "Lontar Peluru"]; 
    const ACARA_BERPASUKAN = ["4x100 meter"];
    const ACARA_SEMUA = [...ACARA_INDIVIDU, ...ACARA_BERPASUKAN];
    const KATEGORI = ["Tahun 1", "Tahun 2", "Tahun 3", "Tahun 4", "Tahun 5", "Tahun 6"]; 
    const LORONG = { "100 meter": 6, "200 meter": 3, "4x100 meter": 3, "100 Meter Berpagar": 6 };
    const MATA = { 
        "1": 6,  // Johan
        "2": 4,  // Kedua
        "3": 3,  // Ketiga
        "4": 1,  // Keempat
        "5": 1,  // Kelima
        "6": 1   // Keenam
    };

    function showLoading() { document.getElementById('loading').style.display = 'flex'; }
    function hideLoading() { document.getElementById('loading').style.display = 'none'; }
    function isAcaraPadang(acara) { return ["Lompat Jauh", "Lompat Tinggi", "Lontar Peluru"].includes(acara); }
    
    function isAcaraAvailable(acara, kategori) {
        const tahun1_3 = ["Tahun 1", "Tahun 2", "Tahun 3"];
        if (acara === "100 Meter Berpagar") {
            return !tahun1_3.includes(kategori);
        }
        if (tahun1_3.includes(kategori)) { 
            if (["200 meter", "Lompat Jauh", "Lompat Tinggi", "Lontar Peluru"].includes(acara)) {
                return false;
            }
        }
        return true; 
    }
    
    function getUniqueKey(acara, kategori, jantina) { 
        return acara.replace(/\s/g, '_') + '|' + kategori.replace(/\s/g, '_') + '|' + jantina; 
    }
    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
    }

    const toUpperCase = (event) => {
        event.target.value = event.target.value.toUpperCase();
    };
    
    // FUNGSI UNTUK CETAK (DIKEMASKINI UNTUK SEMUA JADUAL)
    function printPage(targetId) {
        const title = document.querySelector('h1').textContent;

        // CSS Khas untuk Cetakan yang Kemas (Print Styles)
        const printStyles = `
            @media print {
                body {
                    font-family: Arial, sans-serif;
                    margin: 0;
                    padding: 0;
                    color: #000;
                    background-color: #fff;
                }
                body * {
                    visibility: hidden; /* Sembunyikan semua secara default */
                }
                .print-area, .print-area * {
                    visibility: visible; /* Tunjukkan elemen di dalam kawasan cetak */
                }
                .print-area {
                    position: absolute;
                    left: 0;
                    top: 0;
                    width: 100%;
                    padding: 20px;
                    box-shadow: none;
                }
                
                /* Gaya Jadual (Penting untuk Cetakan) */
                table {
                    width: 100%;
                    border-collapse: collapse;
                    margin-bottom: 20px;
                }
                th, td {
                    border: 1px solid #000 !important;
                    padding: 8px;
                    text-align: left;
                    color: #000 !important;
                }
                th {
                    background-color: #eee !important;
                    -webkit-print-color-adjust: exact;
                }
                
                /* Gaya Elemen Warna (Paksa Warna Hitam & Putih) */
                h1, h2, h3, h4 { color: #000 !important; }
                .rumah-sukan-score, .event-card, .merah, .biru, .kuning {
                    border: 1px solid #000 !important;
                    background-color: #fff !important;
                    color: #000 !important;
                    padding: 5px;
                    display: block; 
                    -webkit-print-color-adjust: exact;
                }
                /* Sembunyikan Butang Cetak dalam paparan cetak itu sendiri */
                .print-area button {
                    display: none;
                    visibility: hidden;
                }
            }
        `;
        
        // --- Logik Cetakan ---
        
        // 1. Cetak Halaman Analisis atau Jana Acara (menggunakan .printable-area)
        if (targetId === 'analisis' || targetId === 'jana') { 
            const targetElement = document.getElementById(targetId);
            const targetArea = targetElement.querySelector('.printable-area');
            
            if (targetArea) {
                const win = window.open('', '_blank');
                win.document.write('<html><head><title>Cetak - ' + title + '</title>');
                win.document.write(`<style>${printStyles.replace('.printable-area', '.print-area')}</style>`);
                win.document.write('</head><body>');
                win.document.write('<h1>' + title + '</h1>');
                win.document.write('<div class="print-area">' + targetArea.innerHTML + '</div>');
                win.document.write('</body></html>');
                win.document.close();
                win.print();
                
                // Jika halaman Jana, tunjukkan butang print semula (kerana ia disembunyikan dalam paparkanJanaAcara)
                if (targetId === 'jana') {
                    document.getElementById('btn-jana-print').style.display = 'block';
                }
            }
        } 
        // 2. Cetak Jadual Pendaftaran Peserta
        else if (targetId === 'table-pendaftaran') { 
            const table = document.getElementById(targetId);
            const win = window.open('', '_blank');
            const printTitle = 'Senarai Pendaftaran Peserta';
            
            // Klon jadual untuk buang lajur Tindakan dalam cetakan
            const tableClone = table.cloneNode(true);
            const headerRow = tableClone.querySelector('thead tr');
            if (headerRow.cells.length > 0) {
                headerRow.deleteCell(headerRow.cells.length - 1); // Padam header Tindakan
            }
            Array.from(tableClone.querySelectorAll('tbody tr')).forEach(row => {
                if (row.cells.length > 0) {
                    row.deleteCell(row.cells.length - 1); // Padam sel Tindakan
                }
            });
            
            win.document.write('<html><head><title>Cetak - ' + printTitle + '</title>');
            win.document.write(`<style>${printStyles.replace('.printable-area', '.print-area')}</style>`);
            win.document.write('</head><body>');
            win.document.write('<h2>' + printTitle + '</h2>');
            win.document.write('<div class="print-area">');
            win.document.write(tableClone.outerHTML);
            win.document.write('</div>');
            
            win.document.close();
            win.print();
        }
        // 3. Cetak Jadual Keputusan Disimpan atau Senarai Peserta/Lorong
        else if (targetId === 'keputusan-disimpan' || targetId === 'table-masuk-keputusan') { 
            const table = document.getElementById(targetId);
            const win = window.open('', '_blank');
            
            let printTitle;
            if (targetId === 'keputusan-disimpan') {
                printTitle = 'Keputusan Disimpan (Rekod Penuh)';
            } else {
                // Ambil tajuk acara dari H3 yang memegang nama acara di halaman Keputusan
                const kepTajukElement = document.getElementById('kep-tajuk');
                let rawTitle = kepTajukElement ? kepTajukElement.textContent : 'Senarai Peserta / Lorong';
                
                // Bersihkan dan format tajuk
                printTitle = rawTitle.replace('Input Keputusan: ', 'Senarai Peserta / Lorong: ');
            }
            
            win.document.write('<html><head><title>Cetak - ' + printTitle + '</title>');
            win.document.write(`<style>${printStyles.replace('.printable-area', '.print-area')}</style>`);
            win.document.write('</head><body>');
            
            // Tajuk Acara dicetak di sini (ini menyelesaikan isu yang dibangkitkan)
            win.document.write('<h2>' + printTitle + '</h2>'); 
            
            win.document.write('<div class="print-area">');
            win.document.write(table.outerHTML);
            win.document.write('</div>');
            
            win.document.close();
            win.print();
        }
    }


    // ====================================================================
    // III. FIREBASE LISTENERS (MUAT DATA REAL-TIME)
    // ====================================================================

    dbRefPendaftaran.on('value', (snapshot) => {
        showLoading();
        const data = snapshot.val();
        pendaftaran = [];
        if (data) {
            Object.keys(data).forEach(key => pendaftaran.push(data[key]));
        }
        paparkanPendaftaran(); 
    });

    dbRefAcaraDijana.on('value', (snapshot) => {
        acaraDijana = snapshot.val() || {};
        // Tunjukkan semula butang print jika jadual jana acara sedang aktif dan ada data
        if (document.getElementById('jana').classList.contains('active') && document.getElementById('table-jana-acara').style.display === 'table') {
             document.getElementById('btn-jana-print').style.display = 'block';
        }
    });

    dbRefKeputusan.on('value', (snapshot) => {
        showLoading();
        const data = snapshot.val();
        keputusan = [];
        if (data) {
            Object.keys(data).forEach(key => keputusan.push(data[key]));
        }
        paparkanKeputusanDisimpan(); 
        if (document.getElementById('analisis').classList.contains('active')) {
             kiraAnalisis();
        }
        hideLoading();
    });


    // ====================================================================
    // IV. PENGURUSAN UI DAN AUTHENTICATION
    // ====================================================================

    function showPage(pageId) {
        if (['jana', 'keputusan'].includes(pageId) && !isAdmin) {
            alert("Akses Ditolak. Sila log masuk sebagai Admin untuk melihat halaman ini.");
            pageId = 'login'; 
        } else if (pageId === 'login' && isAdmin) {
            pageId = 'daftar'; 
        }

        document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
        document.getElementById(pageId).classList.add('active');
        document.querySelectorAll('nav button').forEach(btn => btn.classList.remove('active'));
        
        const navButton = document.getElementById(`nav-${pageId}`);
        if(navButton) navButton.classList.add('active');

        if (pageId === 'analisis') {
            kiraAnalisis();
            paparkanKeputusanDisimpan(); 
        } else if (pageId === 'daftar' || pageId === 'jana' || pageId === 'keputusan') {
            muatkanAcaraPilihan();
            // Reset paparan jana dan keputusan apabila bertukar halaman
            if (pageId !== 'jana') {
                document.getElementById('jana-tajuk').textContent = '';
                document.getElementById('table-jana-acara').style.display = 'none';
                document.getElementById('btn-jana-print').style.display = 'none';
            }
            if (pageId !== 'keputusan') {
                document.getElementById('kep-tajuk').textContent = '';
                document.getElementById('form-masuk-keputusan').style.display = 'none';
            }
        }
    }
    
    // ... (kod toggleNavButtons, logoutAdmin, form-login) ...
    function toggleNavButtons() {
        if (isAdmin) {
            document.getElementById('nav-jana').style.display = 'inline-block';
            document.getElementById('nav-keputusan').style.display = 'inline-block';
            document.getElementById('nav-logout').style.display = 'inline-block';
            document.getElementById('nav-login').style.display = 'none';
        } else {
            document.getElementById('nav-jana').style.display = 'none';
            document.getElementById('nav-keputusan').style.display = 'none';
            document.getElementById('nav-logout').style.display = 'none';
            document.getElementById('nav-login').style.display = 'inline-block';
        }
    }
    
    function logoutAdmin() {
        dbAuth.signOut().then(() => {
            isAdmin = false;
            toggleNavButtons();
            showPage('login');
            document.getElementById('login-status').textContent = 'Anda telah log keluar.';
        });
    }

    document.getElementById('form-login').addEventListener('submit', function(e) {
        e.preventDefault();
        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-password').value;
        const statusElement = document.getElementById('login-status');
        statusElement.textContent = 'Sedang log masuk...';

        dbAuth.signInWithEmailAndPassword(email, password)
            .then((userCredential) => {
                isAdmin = true;
                toggleNavButtons();
                showPage('daftar');
                statusElement.textContent = 'Log masuk berjaya!';
            })
            .catch((error) => {
                statusElement.textContent = `Ralat Log Masuk: ${error.message}`;
            });
    });


    // ====================================================================
    // V. FUNGSI APLIKASI UTAMA
    // ====================================================================

    function muatkanAcaraPilihan() {
        const selects = ['jana-acara', 'kep-acara']; 
        const checkboxDiv = document.getElementById('reg-acara-checkbox'); 
        
        if (document.getElementById('daftar').classList.contains('active')) {
            const selectedKategori = document.getElementById('reg-kategori').value;
            if (checkboxDiv) checkboxDiv.innerHTML = '';
            
            ACARA_SEMUA.forEach(acara => {
                if (isAcaraAvailable(acara, selectedKategori)) {
                    const input = document.createElement('input');
                    input.type = 'checkbox';
                    input.name = 'reg-acara';
                    input.value = acara;
                    input.id = `acara-${acara.replace(/\s/g, '-')}`;
                    input.onchange = toggleNamaInput; 

                    const span = document.createElement('span');
                    span.textContent = acara;

                    const label = document.createElement('label');
                    label.htmlFor = input.id;
                    label.appendChild(input);
                    label.appendChild(span);
                    if (checkboxDiv) checkboxDiv.appendChild(label);
                }
            });
            toggleNamaInput(); 
        }

        selects.forEach(selectId => {
            const selectElement = document.getElementById(selectId);
            if (!selectElement) return;

            const currentValue = selectElement.value;
            
            let selectedKategori; 
            if (selectId.startsWith('jana')) {
                selectedKategori = document.getElementById('jana-kategori').value;
            } else if (selectId.startsWith('kep')) {
                selectedKategori = document.getElementById('kep-kategori').value;
            }
            
            selectElement.innerHTML = '';
            
            let firstAcara = '';
            ACARA_SEMUA.forEach(acara => {
                if (isAcaraAvailable(acara, selectedKategori)) {
                    const option = document.createElement('option');
                    option.value = acara;
                    option.textContent = acara;
                    selectElement.appendChild(option);
                    if (!firstAcara) firstAcara = acara;
                }
            });
            
            if ([...selectElement.options].some(opt => opt.value === currentValue)) {
                selectElement.value = currentValue;
            } else {
                selectElement.value = firstAcara;
            }
        });
    }

    function toggleNamaInput() {
        const selectedCheckboxes = Array.from(document.querySelectorAll('input[name="reg-acara"]:checked'));
        const isRelaySelected = selectedCheckboxes.some(chk => chk.value === '4x100 meter');
        const isIndividualSelected = selectedCheckboxes.some(chk => ACARA_INDIVIDU.includes(chk.value));
        
        const divIndividu = document.getElementById('div-nama-individu');
        const divPasukan = document.getElementById('div-nama-pasukan');
        const inputNama = document.getElementById('reg-nama');
        const inputNoBadan = document.getElementById('reg-no-badan'); 
        const inputPasukan = document.querySelectorAll('.nama-pasukan');
        
        if (inputNama) inputNama.oninput = toUpperCase;
        if (inputNoBadan) inputNoBadan.oninput = toUpperCase;
        inputPasukan.forEach(input => input.oninput = toUpperCase);

        if (isRelaySelected && isIndividualSelected) {
            divIndividu.style.display = 'grid'; 
            divPasukan.style.display = 'none';
            inputNama.required = true;
            if (inputNoBadan) inputNoBadan.required = true; 
            inputPasukan.forEach(input => input.required = false);
        } else if (isRelaySelected) {
            divIndividu.style.display = 'none';
            inputNama.required = false;
            if (inputNoBadan) inputNoBadan.required = false; 
            divPasukan.style.display = 'grid';
            inputPasukan.forEach(input => input.required = true);
        } else if (individualAcaraSelected.length > 0) {
            divIndividu.style.display = 'grid'; 
            inputNama.required = true;
            if (inputNoBadan) inputNoBadan.required = true; 
            divPasukan.style.display = 'none';
            inputPasukan.forEach(input => input.required = false);
        } else {
             divIndividu.style.display = 'grid'; 
             inputNama.required = false;
             if (inputNoBadan) inputNoBadan.required = false; 
             divPasukan.style.display = 'none';
             inputPasukan.forEach(input => input.required = false);
        }
    }

    // --- EVENT LISTENERS UNTUK CATEGORY CHANGE ---
    document.getElementById('reg-kategori').onchange = muatkanAcaraPilihan;
    document.getElementById('jana-kategori').onchange = muatkanAcaraPilihan; 
    document.getElementById('kep-kategori').onchange = muatkanAcaraPilihan; 

    // --- Halaman Daftar Acara (Firebase Write) ---
    document.getElementById('form-daftar-peserta').addEventListener('submit', function(e) {
        e.preventDefault();

        const selectedAcara = Array.from(document.querySelectorAll('input[name="reg-acara"]:checked')).map(chk => chk.value);
        if (selectedAcara.length === 0) { alert('Sila pilih sekurang-kurangnya satu Acara.'); return; }
        
        const kategori = document.getElementById('reg-kategori').value;
        const jantina = document.getElementById('reg-jantina').value;
        const rumah = document.getElementById('reg-rumah').value;

        const isRelaySelected = selectedAcara.includes('4x100 meter');
        const individualAcaraSelected = selectedAcara.filter(acara => ACARA_INDIVIDU.includes(acara));
        
        let peserta;
        let noBadan = '';
        
        if (individualAcaraSelected.length > 3) {
            alert('Had maksimum acara individu ialah 3. Sila batalkan pilihan.');
            return;
        }

        if (isRelaySelected) {
            const namaPasukan = Array.from(document.querySelectorAll('.nama-pasukan')).map(input => input.value.trim()).filter(n => n);
            if (namaPasukan.length !== 4) { alert('Sila masukkan nama 4 peserta untuk 4x100 meter.'); return; }
            peserta = namaPasukan.join(', ');

            if (pendaftaran.some(p => p.acara === '4x100 meter' && p.kategori === kategori && p.jantina === jantina && p.rumah === rumah)) {
                 alert(`Rumah Sukan ${rumah} sudah didaftarkan untuk 4x100 meter ${kategori} ${jantina}.`);
                 return;
            }
        } 
        
        if (individualAcaraSelected.length > 0) {
            peserta = document.getElementById('reg-nama').value.trim();
            noBadan = document.getElementById('reg-no-badan').value.trim().toUpperCase(); 

            if (pendaftaran.some(p => p.noBadan === noBadan && p.noBadan !== '' && p.kategori === kategori && individualAcaraSelected.includes(p.acara))) { 
                alert(`Nombor Badan ${noBadan} telah digunakan oleh peserta lain. Sila gunakan nombor lain.`);
                return;
            }
        }
        
        if (!isRelaySelected && individualAcaraSelected.length === 0) {
            alert('Sila pilih acara yang sah.');
            return;
        }

        showLoading();
        
        let promises = [];
        
        individualAcaraSelected.forEach(acara => {
            const firebaseKey = dbRefPendaftaran.push().key; 
            const dataPeserta = { acara, kategori, jantina, rumah, peserta, noBadan: noBadan, id: firebaseKey }; 
            promises.push(dbRefPendaftaran.child(firebaseKey).set(dataPeserta));
        });
        
        if (isRelaySelected) {
            const firebaseKey = dbRefPendaftaran.push().key; 
            const dataPasukan = { acara: '4x100 meter', kategori, jantina, rumah, peserta, noBadan: 'N/A', id: firebaseKey }; 
            promises.push(dbRefPendaftaran.child(firebaseKey).set(dataPasukan));
        }

        if (promises.length === 0) {
            hideLoading();
            alert('Tiada pendaftaran baru dibuat.');
            return;
        }
        
        Promise.all(promises)
            .then(() => {
                alert(`‚úÖ ${promises.length} pendaftaran berjaya disimpan ke Firebase!`);
                e.target.reset();
                hideLoading(); 
                muatkanAcaraPilihan(); 
            })
            .catch(error => {
                console.error("Ralat pendaftaran:", error);
                alert('Gagal mendaftar. Lihat konsol untuk ralat.');
                hideLoading();
            });
    });

    // FUNGSI PAPARKAN PENDAFTARAN
    function paparkanPendaftaran() {
        const tbody = document.getElementById('table-pendaftaran').getElementsByTagName('tbody')[0];
        tbody.innerHTML = '';
        
        // Susun pendaftaran mengikut Kategori, Jantina, dan Acara
        pendaftaran.sort((a, b) => {
            const kategoriA = KATEGORI.indexOf(a.kategori);
            const kategoriB = KATEGORI.indexOf(b.kategori);
            if (kategoriA !== kategoriB) return kategoriA - kategoriB;
            if (a.jantina !== b.jantina) return a.jantina.localeCompare(b.jantina);
            return a.acara.localeCompare(b.acara);
        });

        pendaftaran.forEach(p => {
            const row = tbody.insertRow();
            row.insertCell().textContent = p.acara;
            row.insertCell().textContent = p.kategori;
            row.insertCell().textContent = p.jantina;
            row.insertCell().textContent = p.rumah;
            row.insertCell().textContent = p.peserta.substring(0, 15) + (p.peserta.length > 15 ? '...' : ''); 
            row.insertCell().textContent = p.noBadan;
            
            const cellTindakan = row.insertCell();
            const deleteButton = document.createElement('button');
            deleteButton.textContent = '‚ùå Padam';
            deleteButton.onclick = () => padamPeserta(p.id);
            deleteButton.className = 'btn';
            deleteButton.style.backgroundColor = '#d32f2f';
            deleteButton.style.padding = '5px 10px';
            deleteButton.style.fontSize = '0.9em';
            if (!isAdmin) deleteButton.disabled = true;
            cellTindakan.appendChild(deleteButton);
        });
        
        hideLoading();
    }

    // FUNGSI PADAM PESERTA
    function padamPeserta(id) {
        if (!isAdmin) return alert("Akses Ditolak. Hanya Admin boleh memadam data.");
        if (confirm('Adakah anda pasti mahu memadam peserta ini?')) {
            showLoading();
            dbRefPendaftaran.child(id).remove()
                .then(() => {
                    alert('Pendaftaran berjaya dipadam.');
                    hideLoading();
                })
                .catch(error => {
                    console.error("Ralat Padam Pendaftaran:", error);
                    alert('Gagal memadam pendaftaran. Lihat konsol untuk ralat.');
                    hideLoading();
                });
        }
    }


    // --- Halaman Jana Acara ---
    async function janaAcara() {
        if (!isAdmin) return alert("Akses Ditolak. Hanya Admin boleh menjana acara.");
        const acara = document.getElementById('jana-acara').value;
        const kategori = document.getElementById('jana-kategori').value;
        const jantina = document.getElementById('jana-jantina').value;
        const key = getUniqueKey(acara, kategori, jantina);
        
        showLoading();

        // Tapis peserta yang layak untuk acara ini
        const pesertaLayak = pendaftaran.filter(p => 
            p.acara === acara && p.kategori === kategori && p.jantina === jantina
        );
        
        if (pesertaLayak.length === 0) {
            hideLoading();
            alert(`Tiada peserta berdaftar untuk ${acara} ${kategori} ${jantina}.`);
            return;
        }

        shuffleArray(pesertaLayak); 
        
        let acaraData = [];
        const isPadang = isAcaraPadang(acara);

        if (isPadang) {
            // Acara Padang: Guna slot sebagai Giliran (1 hingga N)
            acaraData = pesertaLayak.map((p, index) => ({
                id: p.id,
                rumah: p.rumah,
                peserta: p.peserta,
                slot: index + 1 // Giliran
            }));
        } else {
            // Acara Balapan: Guna slot sebagai Lorong (random)
            const maxLorong = LORONG[acara] || 6;
            let lorongTersedia = Array.from({ length: maxLorong }, (_, i) => i + 1);
            shuffleArray(lorongTersedia);
            
            acaraData = pesertaLayak.map((p, index) => ({
                id: p.id,
                rumah: p.rumah,
                peserta: p.peserta,
                slot: lorongTersedia[index % maxLorong] // Guna lorong yang di-shuffle
            }));
            
            // Susun semula mengikut Lorong untuk paparan
            acaraData.sort((a, b) => a.slot - b.slot);
        }

        const dataUntukSimpan = { key, acara, kategori, jantina, peserta: acaraData };
        
        dbRefAcaraDijana.child(key).set(dataUntukSimpan)
            .then(() => {
                paparkanJanaAcara(dataUntukSimpan);
                alert('‚úÖ Acara berjaya dijana dan disimpan!');
                hideLoading();
            })
            .catch(error => {
                console.error("Ralat Jana Acara:", error);
                alert('Gagal menjana acara. Lihat konsol untuk ralat.');
                hideLoading();
            });
    }

    function paparkanJanaAcara(data) {
        if (!data) return;
        
        const isPadang = isAcaraPadang(data.acara);
        const slotLabel = isPadang ? 'Giliran' : 'Lorong';

        document.getElementById('jana-tajuk').textContent = `Senarai ${slotLabel} / Giliran: ${data.acara} ${data.kategori} ${data.jantina}`;
        
        const tbody = document.getElementById('table-jana-acara').getElementsByTagName('tbody')[0];
        const thead = document.querySelector('#table-jana-acara thead tr');
        tbody.innerHTML = '';
        thead.innerHTML = `<th>${slotLabel}</th><th>Rumah Sukan</th><th>Peserta</th>`;

        data.peserta.forEach(p => {
            const row = tbody.insertRow();
            row.insertCell().textContent = p.slot;
            row.insertCell().textContent = p.rumah;
            row.insertCell().textContent = p.peserta;
        });
        document.getElementById('table-jana-acara').style.display = 'table';
        document.getElementById('btn-jana-print').style.display = 'block'; // Tunjukkan butang cetak selepas menjana
    }

    // --- Halaman Keputusan (Firebase Read/Write) ---
    async function paparPesertaKeputusan() {
        if (!isAdmin) return alert("Akses Ditolak. Hanya Admin boleh memasukkan keputusan.");
        const acara = document.getElementById('kep-acara').value;
        const kategori = document.getElementById('kep-kategori').value;
        const jantina = document.getElementById('kep-jantina').value;
        const key = getUniqueKey(acara, kategori, jantina);

        if (!isAcaraAvailable(acara, kategori)) {
             alert(`Acara ${acara} tidak ditawarkan untuk ${kategori}.`);
             document.getElementById('form-masuk-keputusan').style.display = 'none';
             document.getElementById('kep-tajuk').textContent = '';
             return;
        }

        const pesertaDijana = acaraDijana[key] ? acaraDijana[key].peserta : null;
        document.getElementById('kep-tajuk').textContent = `Input Keputusan: ${acara} ${kategori} ${jantina}`;
        document.getElementById('form-masuk-keputusan').style.display = 'none';
        
        if (!pesertaDijana || pesertaDijana.length === 0) {
            alert('Sila Jana Acara & Lorong di Halaman "Jana Acara & Lorong" dahulu.');
            return;
        }

        const isPadang = isAcaraPadang(acara);
        const unit = isPadang ? 'meter (m)' : 'saat (s)';

        const tbody = document.getElementById('table-masuk-keputusan').getElementsByTagName('tbody')[0];
        const thead = document.querySelector('#table-masuk-keputusan thead tr');
        tbody.innerHTML = '';
        
        // ‚ö†Ô∏è BORANG KHAS UNTUK ACARA PADANG
        if (isPadang) {
            let numPercubaan = 3; 
            if (acara === 'Lompat Tinggi') {
                numPercubaan = 6; 
            }

            // HEADER JADUAL PADANG
            let headerHTML = '<th>Rumah Sukan</th><th>Peserta</th>';
            for (let i = 1; i <= numPercubaan; i++) {
                headerHTML += `<th>P${i}</th>`;
            }
            headerHTML += `<th>PB (${unit})</th><th>Kedudukan (1-6)</th>`;
            thead.innerHTML = headerHTML;
            
            pesertaDijana.sort((a, b) => a.slot - b.slot).forEach((p, index) => {
                const row = tbody.insertRow();
                row.dataset.key = key;
                row.dataset.rumah = p.rumah;
                row.dataset.id = p.id; 
                row.insertCell().textContent = p.rumah;
                row.insertCell().textContent = p.peserta;

                // Input Percubaan
                for (let i = 1; i <= numPercubaan; i++) {
                    const cell = row.insertCell();
                    const input = document.createElement('input');
                    input.type = 'number';
                    input.step = 'any';
                    input.name = `P${i}-${index}`;
                    cell.appendChild(input);
                }

                // Input Keputusan Terbaik (PB)
                const cellPB = row.insertCell();
                const inputPB = document.createElement('input');
                inputPB.type = 'number';
                inputPB.step = 'any';
                inputPB.name = `PB-${index}`;
                cellPB.appendChild(inputPB);
                
                // Input Kedudukan
                const cellKedudukan = row.insertCell();
                const inputKedudukan = document.createElement('select');
                inputKedudukan.name = `kedudukan-${index}`;
                inputKedudukan.innerHTML = '<option value="">-</option><option value="1">1 (6 M)</option><option value="2">2 (4 M)</option><option value="3">3 (3 M)</option><option value="4">4 (1 M)</option><option value="5">5 (1 M)</option><option value="6">6 (1 M)</option>';
                cellKedudukan.appendChild(inputKedudukan);

                // Pra-isi data (jika ada keputusan sedia ada)
                const resultExisting = keputusan.find(k => k.key === key);
                if (resultExisting) {
                    const pesertaResult = resultExisting.results.find(r => r.id === p.id);
                    if (pesertaResult) {
                        for (let i = 1; i <= numPercubaan; i++) {
                            row.querySelector(`input[name="P${i}-${index}"]`).value = pesertaResult[`P${i}`] || '';
                        }
                        inputPB.value = pesertaResult.keputusan;
                        inputKedudukan.value = pesertaResult.kedudukan.toString();
                    }
                }
            });

        } else {
            // ACARA BALAPAN 
            thead.innerHTML = '<th>Rumah Sukan</th><th>Peserta</th><th>Keputusan (<span id="unit-keputusan-balapan"></span>)</th><th>Kedudukan (1 - 6)</th>';
            document.getElementById('unit-keputusan-balapan').textContent = unit;
            
            pesertaDijana.sort((a, b) => a.slot - b.slot).forEach((p, index) => {
                const row = tbody.insertRow();
                row.dataset.key = key;
                row.dataset.rumah = p.rumah;
                row.dataset.id = p.id; 
                row.insertCell().textContent = p.rumah;
                row.insertCell().textContent = p.peserta;
                
                const cellKeputusan = row.insertCell();
                const inputKeputusan = document.createElement('input');
                inputKeputusan.type = 'number';
                inputKeputusan.step = 'any';
                inputKeputusan.name = `keputusan-${index}`;
                inputKeputusan.required = false; 
                cellKeputusan.appendChild(inputKeputusan);
                
                const cellKedudukan = row.insertCell();
                const inputKedudukan = document.createElement('select');
                inputKedudukan.name = `kedudukan-${index}`;
                inputKedudukan.innerHTML = '<option value="">-</option><option value="1">1 (6 M)</option><option value="2">2 (4 M)</option><option value="3">3 (3 M)</option><option value="4">4 (1 M)</option><option value="5">5 (1 M)</option><option value="6">6 (1 M)</option>';
                cellKedudukan.appendChild(inputKedudukan);

                const resultExisting = keputusan.find(k => k.key === key);
                if (resultExisting) {
                    const pesertaResult = resultExisting.results.find(r => r.id === p.id);
                    if (pesertaResult) {
                        inputKeputusan.value = pesertaResult.keputusan;
                        inputKedudukan.value = pesertaResult.kedudukan.toString();
                    }
                }
            });
        }
        document.getElementById('form-masuk-keputusan').style.display = 'block';
    }

    // --- SUBMIT KEPUTUSAN (Diperbaiki untuk Padang) ---
    document.getElementById('form-masuk-keputusan').addEventListener('submit', function(e) {
        if (!isAdmin) return alert("Akses Ditolak. Hanya Admin boleh menyimpan keputusan.");
        e.preventDefault();
        
        const tbody = document.getElementById('table-masuk-keputusan').getElementsByTagName('tbody')[0];
        const rows = Array.from(tbody.rows);
        const key = rows[0].dataset.key;
        const [acara, kategori, jantina] = key.split('|').map(s => s.replace(/_/g, ' ')); 
        const isPadang = isAcaraPadang(acara);

        let results = [];
        let kedudukanUsed = [];

        for (let index = 0; index < rows.length; index++) {
            const row = rows[index];
            const rumah = row.dataset.rumah;
            const peserta = row.cells[1].textContent;
            const id = row.dataset.id; 
            let resultEntry = { id, rumah, peserta };
            let kedudukanVal = 0;
            let keputusanVal = 0;

            if (isPadang) {
                const numPercubaan = (acara === 'Lompat Tinggi') ? 6 : 3;
                
                const inputKedudukan = row.querySelector(`select[name="kedudukan-${index}"]`);
                const inputPB = row.querySelector(`input[name="PB-${index}"]`);
                
                kedudukanVal = inputKedudukan.value ? parseInt(inputKedudukan.value) : 0;
                keputusanVal = inputPB.value ? parseFloat(inputPB.value) : 0;
                
                for (let i = 1; i <= numPercubaan; i++) {
                    const inputP = row.querySelector(`input[name="P${i}-${index}"]`);
                    resultEntry[`P${i}`] = inputP.value ? parseFloat(inputP.value) : null;
                }
                
            } else {
                // Balapan
                const inputKedudukan = row.querySelector(`select[name="kedudukan-${index}"]`);
                const inputKeputusan = row.querySelector(`input[name="keputusan-${index}"]`);
                
                kedudukanVal = inputKedudukan.value ? parseInt(inputKedudukan.value) : 0;
                keputusanVal = inputKeputusan.value ? parseFloat(inputKeputusan.value) : 0;
            }

            // Semak Kedudukan Duplikasi
            if (kedudukanVal !== 0) {
                if (kedudukanUsed.includes(kedudukanVal)) {
                    alert(`Kedudukan ${kedudukanVal} telah diberikan lebih daripada sekali. Sila betulkan.`);
                    return;
                }
                kedudukanUsed.push(kedudukanVal);
            }

            if (kedudukanVal !== 0) {
                resultEntry.kedudukan = kedudukanVal;
                resultEntry.keputusan = keputusanVal; 
                resultEntry.mata = MATA[kedudukanVal];
                results.push(resultEntry);
            }
        }
        
        // Pastikan 3 kedudukan teratas telah diisi
        const top3Filled = [1, 2, 3].every(rank => kedudukanUsed.includes(rank));
        if (!top3Filled) {
             const confirmSkip = confirm("Kedudukan 1, 2, atau 3 tidak lengkap. Adakah anda pasti mahu menyimpan keputusan yang tidak lengkap?");
             if (!confirmSkip) return;
        }

        const resultData = {
            key, acara, kategori, jantina,
            results: results.sort((a, b) => a.kedudukan - b.kedudukan)
        };
        
        dbRefKeputusan.child(key).set(resultData)
            .then(() => {
                alert('Keputusan dan mata telah dikira dan disimpan ke Firebase!');
                document.getElementById('form-masuk-keputusan').style.display = 'none';
                document.getElementById('kep-tajuk').textContent = '';
            })
            .catch(error => {
                console.error("Ralat Simpan Keputusan:", error);
                alert('Gagal menyimpan keputusan. Lihat konsol untuk ralat.');
            });
    });

    // FUNGSI PAPARKAN KEPUTUSAN DISIMPAN
    function paparkanKeputusanDisimpan() {
        const tbodyKeputusan = document.getElementById('table-keputusan-disimpan').getElementsByTagName('tbody')[0];
        const tbodyAnalisis = document.getElementById('table-keputusan-pemenang-analisis') ? document.getElementById('table-keputusan-pemenang-analisis').getElementsByTagName('tbody')[0] : null;

        tbodyKeputusan.innerHTML = '';
        if (tbodyAnalisis) tbodyAnalisis.innerHTML = ''; 
        
        const keputusanTersusun = [...keputusan].sort((a, b) => {
            if (a.acara !== b.acara) return a.acara.localeCompare(b.acara);
            const kategoriA = KATEGORI.indexOf(a.kategori);
            const kategoriB = KATEGORI.indexOf(b.kategori);
            if (kategoriA !== kategoriB) return kategoriA - kategoriB;
            return a.jantina.localeCompare(b.jantina);
        });

        keputusanTersusun.forEach(k => {
            const juara = k.results.find(r => r.kedudukan === 1);
            const kedua = k.results.find(r => r.kedudukan === 2);
            const ketiga = k.results.find(r => r.kedudukan === 3);

            const getPesertaDisplay = (r) => r ? `${r.rumah} (${r.peserta.substring(0, 15)}${r.peserta.length > 15 ? '...' : ''})` : '-';


            // Masukkan ke jadual di halaman Keputusan
            const rowKeputusan = tbodyKeputusan.insertRow();
            rowKeputusan.insertCell().textContent = k.acara;
            rowKeputusan.insertCell().textContent = k.kategori;
            rowKeputusan.insertCell().textContent = k.jantina;
            rowKeputusan.insertCell().textContent = getPesertaDisplay(juara);
            rowKeputusan.insertCell().textContent = getPesertaDisplay(kedua);
            rowKeputusan.insertCell().textContent = getPesertaDisplay(ketiga);


            // Masukkan juga ke jadual di halaman Analisis
            if (tbodyAnalisis) {
                const rowAnalisis = tbodyAnalisis.insertRow();
                rowAnalisis.insertCell().textContent = k.acara;
                rowAnalisis.insertCell().textContent = k.kategori;
                rowAnalisis.insertCell().textContent = k.jantina;
                rowAnalisis.insertCell().textContent = getPesertaDisplay(juara);
                rowAnalisis.insertCell().textContent = getPesertaDisplay(kedua);
                rowAnalisis.insertCell().textContent = getPesertaDisplay(ketiga);
            }
        });
    }
    
    // FUNGSI ANALISIS 
    function kiraAnalisis() {
        let markahRumah = { "Merah": 0, "Biru": 0, "Kuning": 0 };
        let pecahanAcara = {}; 

        keputusan.forEach(k => {
            const key = k.key;
            pecahanAcara[key] = {
                Merah: 0, Biru: 0, Kuning: 0,
                acara: k.acara, kategori: k.kategori, jantina: k.jantina
            };

            k.results.forEach(r => {
                if (r.kedudukan >= 1 && r.kedudukan <= 6) { 
                    markahRumah[r.rumah] += r.mata;
                    pecahanAcara[key][r.rumah] += r.mata;
                }
            });
        });

        document.getElementById('score-merah').querySelector('.total-points').textContent = markahRumah.Merah;
        document.getElementById('score-biru').querySelector('.total-points').textContent = markahRumah.Biru;
        document.getElementById('score-kuning').querySelector('.total-points').textContent = markahRumah.Kuning;

        const pecahanDiv = document.getElementById('pecahan-markah');
        pecahanDiv.innerHTML = '';
        
        const keysSorted = Object.keys(pecahanAcara).sort((a, b) => {
            const dataA = pecahanAcara[a];
            const dataB = pecahanAcara[b];
            
            if (dataA.acara !== dataB.acara) return dataA.acara.localeCompare(dataB.acara);
            const kategoriA = KATEGORI.indexOf(dataA.kategori);
            const kategoriB = KATEGORI.indexOf(dataB.kategori);
            if (kategoriA !== kategoriB) return kategoriA - kategoriB;
            return dataA.jantina.localeCompare(dataB.jantina);
        });

        keysSorted.forEach(key => {
            const data = pecahanAcara[key];
            const eventDiv = document.createElement('div');
            eventDiv.className = 'event-card';
            eventDiv.innerHTML = `
                <h4>${data.acara} - ${data.kategori} ${data.jantina}</h4>
                <p>
                    <span class="merah" style="padding: 2px 5px; border-radius: 3px;">Merah: <b>${data.Merah}</b> mata</span> |
                    <span class="biru" style="padding: 2px 5px; border-radius: 3px;">Biru: <b>${data.Biru}</b> mata</span> |
                    <span class="kuning" style="padding: 2px 5px; border-radius: 3px;">Kuning: <b>${data.Kuning}</b> mata</span>
                </p>
            `;
            pecahanDiv.appendChild(eventDiv);
        });
        
        paparkanKeputusanDisimpan(); 
    }

    // --- Inisialisasi Aplikasi ---
    document.addEventListener('DOMContentLoaded', () => {
        muatkanAcaraPilihan(); 
        toggleNavButtons(); // Semak status Admin pada permulaan
    });

</script>
</body>
</html>
