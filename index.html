<!DOCTYPE html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üèÜ Kejohanan Olahraga SK Abang Gesa 2025 (Firebase)</title>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-database.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-auth.js"></script>
    <style>
        /* Gaya Asas */
        body { font-family: 'Arial', sans-serif; margin: 0; padding: 0; background-color: #f4f4f9; color: #333; }
        .container { max-width: 1200px; margin: 20px auto; padding: 20px; background-color: #fff; border-radius: 8px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); }
        h1, h2 { color: #004d40; text-align: center; }
        nav { background-color: #00796b; padding: 10px 0; border-radius: 6px 6px 0 0; display: flex; justify-content: center; }
        nav button { background: none; border: none; color: white; padding: 10px 20px; margin: 0 5px; cursor: pointer; font-size: 16px; transition: background-color 0.3s; border-radius: 4px; }
        nav button:hover, nav button.active { background-color: #004d40; }
        /* Gaya untuk Butang Admin (Akan dikawal oleh JS) */
        #nav-jana, #nav-keputusan { display: none; } 
        .page { display: none; padding: 20px 0; }
        .page.active { display: block; }

        /* Gaya Borang */
        form, .data-entry { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; padding: 20px; border: 1px solid #ccc; border-radius: 6px; margin-bottom: 20px; }
        .data-entry { grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); }
        label { font-weight: bold; margin-bottom: 5px; display: block; color: #004d40; }
        input[type="text"], input[type="number"], select, input[type="email"], input[type="password"] { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        button[type="submit"], .btn { background-color: #00796b; color: white; padding: 10px 15px; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; transition: background-color 0.3s; }
        button[type="submit"]:hover, .btn:hover { background-color: #004d40; }
        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.8); display: none; justify-content: center; align-items: center; z-index: 1000; font-size: 20px; font-weight: bold; color: #004d40; }

        /* Gaya Jadual */
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        th { background-color: #e0f2f1; color: #004d40; }
        tr:nth-child(even) { background-color: #f9f9f9; }
        /* Gaya untuk input kecil dalam Jadual Keputusan Padang */
        #table-masuk-keputusan input[type="number"], #table-masuk-keputusan select { padding: 5px; font-size: 0.9em; width: 100%; min-width: 50px; box-sizing: border-box; }
        #table-masuk-keputusan td:nth-child(4), 
        #table-masuk-keputusan td:nth-child(5), 
        #table-masuk-keputusan td:nth-child(6) { max-width: 60px; } /* Percubaan Padang */
        
        /* Gaya Checkbox untuk Acara */
        .checkbox-group-acara { grid-column: 1 / -1; display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 15px; }
        .checkbox-group-acara label { display: inline-flex; align-items: center; background-color: #e0f2f1; padding: 8px 12px; border-radius: 4px; cursor: pointer; font-weight: normal; transition: background-color 0.2s; }
        .checkbox-group-acara input[type="checkbox"] { margin-right: 5px; }
        .checkbox-group-acara label:hover, .checkbox-group-acara input[type="checkbox"]:checked + span { background-color: #00796b; color: white; }
        .checkbox-group-acara label input[type="checkbox"] { display: none; }
        .checkbox-group-acara label input[type="checkbox"]:checked + span { background-color: #00796b; color: white; padding: 8px 12px; border-radius: 4px; }
        .checkbox-group-acara label span { padding: 8px 12px; border-radius: 4px; }

        /* Gaya Analisis / Keputusan */
        .results-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 20px; }
        .rumah-sukan-score { padding: 15px; border-radius: 6px; text-align: center; }
        .merah { background-color: #ffebee; border: 2px solid #e53935; color: #e53935; }
        .biru { background-color: #e3f2fd; border: 2px solid #2196f3; color: #2196f3; }
        .kuning { background-color: #fffde7; border: 2px solid #ffeb3b; color: #ffc107; }
        .score-title { font-size: 1.2em; font-weight: bold; margin-bottom: 5px; }
        .total-points { font-size: 2.5em; font-weight: bold; }
        .event-card { border: 1px solid #00796b; border-radius: 6px; padding: 15px; margin-bottom: 10px; background-color: #f0fdfc; }
        
        /* Media Query untuk Cetak */
        @media print {
            body * { visibility: hidden; }
            /* Memastikan hanya kandungan yang dipilih untuk dicetak dipaparkan */
            .printable-area, .printable-area * { visibility: visible; }
            .printable-area { position: absolute; left: 0; top: 0; width: 100%; padding: 20px; box-shadow: none; }
            nav, .data-entry, button, .btn { display: none; } 
            .container { box-shadow: none; margin: 0; max-width: none; }
            h1, h2 { color: #000; }
            table, th, td { border: 1px solid #000 !important; }
            .rumah-sukan-score { border: 1px solid #000 !important; background-color: #fff !important; color: #000 !important; -webkit-print-color-adjust: exact; }
            .merah, .biru, .kuning, .event-card { border: 1px solid #000 !important; background-color: #fff !important; color: #000 !important; }
            .event-card p span { border: none !important; background-color: #fff !important; color: #000 !important; }
        }
    </style>
</head>
<body>

<div class="loading-overlay" id="loading">Memuatkan Data...</div>

<div class="container">
    <h1>üèÜ Kejohanan Olahraga Tahunan SK Abang Gesa 2025 (Firebase)</h1>
    <nav>
        <button onclick="showPage('daftar')" id="nav-daftar" class="active">üìù Daftar Acara</button>
        <button onclick="showPage('jana')" id="nav-jana">üèÉ Jana Acara & Lorong</button>
        <button onclick="showPage('keputusan')" id="nav-keputusan">ü•á Keputusan & Markah</button>
        <button onclick="showPage('analisis')" id="nav-analisis">üìä Analisis Keseluruhan</button>
        </nav>

    <div id="login" class="page active">
        <h2>üîí Log Masuk Admin</h2>
        <form id="form-login" style="max-width: 400px; margin: 20px auto; display: grid; grid-template-columns: 1fr; gap: 10px;">
            <div>
                <label for="login-email">Emel Admin:</label>
                <input type="email" id="login-email" required placeholder="admin@sekolah.edu.my">
            </div>
            <div>
                <label for="login-password">Kata Laluan:</label>
                <input type="password" id="login-password" required placeholder="*****">
            </div>
            <button type="submit">Log Masuk</button>
            <p id="login-status" style="color: red; text-align: center;"></p>
        </form>
        <p style="text-align: center;">Hanya Admin boleh mengakses bahagian Jana Acara dan Keputusan.</p>
    </div>

    <div id="daftar" class="page">
        <h2>üìù Daftar Peserta</h2>
        <form id="form-daftar-peserta">
            <div style="grid-column: 1 / -1;"><label>Acara (Pilih Acara Individu atau 4x100m, maksimum 4 acara):</label>
                <div id="reg-acara-checkbox" class="checkbox-group-acara">
                    </div>
            </div>
            
            <div><label for="reg-kategori">Kategori (Tahun):</label><select id="reg-kategori" required>
                <option value="Tahun 1">Tahun 1</option>
                <option value="Tahun 2">Tahun 2</option>
                <option value="Tahun 3">Tahun 3</option>
                <option value="Tahun 4">Tahun 4</option>
                <option value="Tahun 5">Tahun 5</option>
                <option value="Tahun 6">Tahun 6</option>
            </select></div>
            <div><label for="reg-jantina">Jantina:</label><select id="reg-jantina" required><option value="Lelaki">Lelaki</option><option value="Perempuan">Perempuan</option></select></div>
            <div><label for="reg-rumah">Rumah Sukan:</label><select id="reg-rumah" required><option value="Merah">Rumah Sukan Merah</option><option value="Biru">Rumah Sukan Biru</option><option value="Kuning">Rumah Sukan Kuning</option></select></div>
            
            <div id="div-nama-individu" style="grid-column: 1 / -1; display: grid; grid-template-columns: 3fr 1fr; gap: 10px;">
                <div>
                    <label for="reg-nama">Nama Peserta:</label>
                    <input type="text" id="reg-nama" placeholder="Nama Penuh Peserta" required>
                </div>
                <div>
                    <label for="reg-no-badan">Nombor Badan:</label>
                    <input type="text" id="reg-no-badan" placeholder="e.g., A123" required>
                </div>
            </div>
            
            <div id="div-nama-pasukan" style="display: none; grid-column: 1 / -1;">
                <label>Nama 4 Peserta (4x100m) - **Huruf Besar Automatik**:</label>
                <input type="text" class="nama-pasukan" placeholder="Peserta 1" required>
                <input type="text" class="nama-pasukan" placeholder="Peserta 2" required>
                <input type="text" class="nama-pasukan" placeholder="Peserta 3" required>
                <input type="text" class="nama-pasukan" placeholder="Peserta 4" required>
            </div>
            <button type="submit" style="grid-column: 1 / -1;">‚ûï Daftar Peserta</button>
        </form>

        <h3>Senarai Peserta Berdaftar</h3>
        <table id="table-pendaftaran">
<thead><tr><th>Acara</th><th>Kategori</th><th>Jantina</th><th>Rumah Sukan</th><th>Peserta</th><th>No. Badan</th><th>Tindakan</th></tr></thead>
            <tbody></tbody>
        </table>
    </div>

    <div id="jana" class="page">
        <h2>üèÉ Jana Acara & Lorong</h2>
        <button class="btn" onclick="printPage('jana')" style="float: right; margin-bottom: 20px;">üñ®Ô∏è Cetak Senarai Lorong/Giliran</button>
        <div class="data-entry">
            <div><label for="jana-acara">Pilih Acara untuk Dijana:</label><select id="jana-acara"></select></div>
            <div><label for="jana-kategori">Pilih Kategori:</label><select id="jana-kategori">
                <option value="Tahun 1">Tahun 1</option>
                <option value="Tahun 2">Tahun 2</option>
                <option value="Tahun 3">Tahun 3</option>
                <option value="Tahun 4">Tahun 4</option>
                <option value="Tahun 5">Tahun 5</option>
                <option value="Tahun 6">Tahun 6</option>
            </select></div>
            <div><label for="jana-jantina">Pilih Jantina:</label><select id="jana-jantina"><option value="Lelaki">Lelaki</option><option value="Perempuan">Perempuan</option></select></div>
            <div><button onclick="janaAcara()">üöÄ Jana Acara & Lorong</button></div>
        </div>
        
        <div class="printable-area">
            <h3 id="jana-tajuk"></h3>
            <p id="jana-status"></p>
            <table id="table-jana-acara" style="display: none;">
                <thead><tr><th>Lorong/Giliran</th><th>Rumah Sukan</th><th>Peserta</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <div id="keputusan" class="page">
        <h2>ü•á Masukkan Keputusan & Mata</h2>
        <div class="data-entry">
            <div><label for="kep-acara">Pilih Acara:</label><select id="kep-acara"></select></div>
            <div><label for="kep-kategori">Pilih Kategori:</label><select id="kep-kategori">
                <option value="Tahun 1">Tahun 1</option>
                <option value="Tahun 2">Tahun 2</option>
                <option value="Tahun 3">Tahun 3</option>
                <option value="Tahun 4">Tahun 4</option>
                <option value="Tahun 5">Tahun 5</option>
                <option value="Tahun 6">Tahun 6</option>
            </select></div>
            <div><label for="kep-jantina">Pilih Jantina:</label><select id="kep-jantina"><option value="Lelaki">Lelaki</option><option value="Perempuan">Perempuan</option></select></div>
            <div><button onclick="paparPesertaKeputusan()">üîç Muatkan Peserta</button></div>
        </div>

        <h3 id="kep-tajuk"></h3>
        <form id="form-masuk-keputusan" style="display: none; grid-template-columns: 1fr;">
            <table id="table-masuk-keputusan">
                <thead><tr><th>Rumah Sukan</th><th>Peserta</th><th>Keputusan (<span id="unit-keputusan"></span>)</th><th>Kedudukan (1 - 6)</th></tr></thead>
                <tbody></tbody>
            </table>
            <button type="submit">‚úÖ Simpan Keputusan & Kira Mata</button>
        </form>

        <h3>Keputusan Disimpan</h3>
        <button class="btn" onclick="printPage('keputusan-disimpan')" style="float: right; margin-bottom: 10px;">üñ®Ô∏è Cetak Senarai Pemenang</button>
        <div id="keputusan-disimpan-area" class="printable-area">
            <table id="table-keputusan-disimpan">
                 <thead><tr><th>Acara</th><th>Kategori</th><th>Jantina</th><th>Juara (6 M)</th><th>Kedua (4 M)</th><th>Ketiga (3 M)</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <div id="analisis" class="page">
        <h2>üìä Analisis Keseluruhan Rumah Sukan</h2>
        <button class="btn" onclick="printPage('analisis')" style="float: right; margin-bottom: 20px;">üñ®Ô∏è Cetak Analisis</button>

        <div class="printable-area">
            <div class="results-grid">
                <div id="score-merah" class="rumah-sukan-score merah"><div class="score-title">Rumah Sukan Merah</div><div class="total-points">0</div></div>
                <div id="score-biru" class="rumah-sukan-score biru"><div class="score-title">Rumah Sukan Biru</div><div class="total-points">0</div></div>
                <div id="score-kuning" class="rumah-sukan-score kuning"><div class="score-title">Rumah Sukan Kuning</div><div class="total-points">0</div></div>
            </div>
            
            <h3>3. Pecahan Markah Mengikut Acara</h3>
            <div id="pecahan-markah"></div>

            <h3>4. Jadual Keputusan Pemenang Mengikut Acara</h3>
            <table id="table-keputusan-pemenang-analisis">
                 <thead><tr><th>Acara</th><th>Kategori</th><th>Jantina</th><th>Juara (6 M)</th><th>Kedua (4 M)</th><th>Ketiga (3 M)</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>
</div>

<script>
    // ====================================================================
    // I. KONFIGURASI FIREBASE (SILA GANTI DENGAN MAKLUMAT ANDA)
    // ====================================================================
    const firebaseConfig = {
        // ‚ö†Ô∏è SILA GANTI konfigurasi ini dengan maklumat projek Firebase anda sendiri!
        apiKey: "AIzaSyCqK3mYKfkHE4N67qFNpFqg1nrCzOtCJqo",
        authDomain: "kot-sk-abang-gesa-2025.firebaseapp.com",
        databaseURL: "https://kot-sk-abang-gesa-2025-default-rtdb.asia-southeast1.firebasedatabase.app", 
        projectId: "kot-sk-abang-gesa-2025",
        storageBucket: "kot-sk-abang-gesa-2025.firebasestorage.app",
        messagingSenderId: "67901274927",
        appId: "1:67901274927:web:198aba9aaae160e7623fda"
    };

    // Inisialisasi Firebase
    if (firebaseConfig.apiKey.includes("GANTI_DENGAN_")) {
        // ... (kod inisialisasi Firebase)
    } else {
        firebase.initializeApp(firebaseConfig);
    }
    const db = firebase.database();
    const dbAuth = firebase.auth(); 
    
    // Rujukan kepada nod data utama
    const dbRefPendaftaran = db.ref('pendaftaran');
    const dbRefAcaraDijana = db.ref('acaraDijana');
    const dbRefKeputusan = db.ref('keputusan');
    
    // --- Data Model Lokal (Untuk Cache) ---
    let pendaftaran = [];
    let acaraDijana = {}; 
    let keputusan = [];
    let isAdmin = false; 

    // ====================================================================
    // II. DATA DAN UTILITIES
    // ====================================================================
    
    const ACARA_INDIVIDU = ["100 meter", "200 meter", "100 Meter Berpagar", "Lompat Jauh", "Lompat Tinggi", "Lontar Peluru"]; 
    const ACARA_BERPASUKAN = ["4x100 meter"];
    const ACARA_SEMUA = [...ACARA_INDIVIDU, ...ACARA_BERPASUKAN];
    const KATEGORI = ["Tahun 1", "Tahun 2", "Tahun 3", "Tahun 4", "Tahun 5", "Tahun 6"]; 
    const LORONG = { "100 meter": 6, "200 meter": 3, "4x100 meter": 3, "100 Meter Berpagar": 6 };
    const MATA = { 
        "1": 6,  // Johan
        "2": 4,  // Kedua
        "3": 3,  // Ketiga
        "4": 1,  // Keempat
        "5": 1,  // Kelima
        "6": 1   // Keenam
    };

    function showLoading() { document.getElementById('loading').style.display = 'flex'; }
    function hideLoading() { document.getElementById('loading').style.display = 'none'; }
    function isAcaraPadang(acara) { return ["Lompat Jauh", "Lompat Tinggi", "Lontar Peluru"].includes(acara); }
    
    function isAcaraAvailable(acara, kategori) {
        // ... (kod sedia ada) ...
        const tahun1_3 = ["Tahun 1", "Tahun 2", "Tahun 3"];
        if (acara === "100 Meter Berpagar") {
            return !tahun1_3.includes(kategori);
        }
        if (tahun1_3.includes(kategori)) { 
            if (["200 meter", "Lompat Jauh", "Lompat Tinggi", "Lontar Peluru"].includes(acara)) {
                return false;
            }
        }
        return true; 
    }
    
    function getUniqueKey(acara, kategori, jantina) { 
        return acara.replace(/\s/g, '_') + '|' + kategori.replace(/\s/g, '_') + '|' + jantina; 
    }
    function shuffleArray(array) {
        // ... (kod sedia ada) ...
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
    }

    const toUpperCase = (event) => {
        event.target.value = event.target.value.toUpperCase();
    };
    
    // FUNGSI BARU UNTUK CETAK (ISU 1 & 2)
    function printPage(targetId) {
        const title = document.querySelector('h1').textContent;
        const targetElement = document.getElementById(targetId);

        if (targetId === 'analisis' || targetId === 'jana') {
            // Untuk halaman yang mempunyai 'printable-area' pada elemen h3/table
            const targetArea = targetElement.querySelector('.printable-area');
            if (targetArea) {
                const win = window.open('', '_blank');
                win.document.write('<html><head><title>Cetak - ' + title + '</title>');
                win.document.write('<style>');
                win.document.write('@media print { body * { visibility: hidden; } .printable-area, .printable-area * { visibility: visible; } .printable-area { position: absolute; left: 0; top: 0; width: 100%; padding: 20px; box-shadow: none; } h1, h2, h3, h4 { color: #000 !important; } table, th, td { border: 1px solid #000 !important; } .rumah-sukan-score, .event-card { border: 1px solid #000 !important; background-color: #fff !important; color: #000 !important; -webkit-print-color-adjust: exact; } }');
                win.document.write('</style></head><body>');
                win.document.write('<h1>' + title + '</h1>');
                win.document.write(targetArea.innerHTML);
                win.document.write('</body></html>');
                win.document.close();
                win.print();
            }
        } else if (targetId === 'keputusan-disimpan') {
             // Untuk bahagian Jadual Keputusan Disimpan
            const table = document.getElementById('table-keputusan-disimpan');
            const win = window.open('', '_blank');
            win.document.write('<html><head><title>Cetak - Keputusan Disimpan</title>');
            win.document.write('<style>');
            win.document.write('@media print { body * { visibility: hidden; } #print-table, #print-table * { visibility: visible; } #print-table { position: absolute; left: 0; top: 0; width: 100%; padding: 20px; } table, th, td { border: 1px solid #000 !important; } }');
            win.document.write('</style></head><body>');
            win.document.write('<h2>Keputusan Disimpan</h2>');
            win.document.write('<div id="print-table">' + table.outerHTML + '</div>');
            win.document.write('</body></html>');
            win.document.close();
            win.print();
        }
    }


    // ====================================================================
    // III. FIREBASE LISTENERS (MUAT DATA REAL-TIME)
    // ====================================================================
    // ... (kod sedia ada) ...

    dbRefPendaftaran.on('value', (snapshot) => {
        showLoading();
        const data = snapshot.val();
        pendaftaran = [];
        if (data) {
            Object.keys(data).forEach(key => pendaftaran.push(data[key]));
        }
        paparkanPendaftaran();
    });

    dbRefAcaraDijana.on('value', (snapshot) => {
        acaraDijana = snapshot.val() || {};
    });

    dbRefKeputusan.on('value', (snapshot) => {
        showLoading();
        const data = snapshot.val();
        keputusan = [];
        if (data) {
            Object.keys(data).forEach(key => keputusan.push(data[key]));
        }
        paparkanKeputusanDisimpan(); // Diperbaiki untuk isi 2 jadual
        if (document.getElementById('analisis').classList.contains('active')) {
             kiraAnalisis();
        }
        hideLoading();
    });


    // ====================================================================
    // IV. PENGURUSAN UI DAN AUTHENTICATION
    // ====================================================================
    // ... (kod sedia ada) ...

    function showPage(pageId) {
        // ... (kod sedia ada) ...
        if (['jana', 'keputusan'].includes(pageId) && !isAdmin) {
            alert("Akses Ditolak. Sila log masuk sebagai Admin untuk melihat halaman ini.");
            pageId = 'login'; 
        } else if (pageId === 'login' && isAdmin) {
            pageId = 'daftar'; 
        }

        document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
        document.getElementById(pageId).classList.add('active');
        document.querySelectorAll('nav button').forEach(btn => btn.classList.remove('active'));
        
        const navButton = document.getElementById(`nav-${pageId}`);
        if(navButton) navButton.classList.add('active');

        if (pageId === 'analisis') {
            kiraAnalisis();
            paparkanKeputusanDisimpan(); // Pastikan jadual pemenang diisi (ISU 3)
        } else if (pageId === 'daftar' || pageId === 'jana' || pageId === 'keputusan') {
            muatkanAcaraPilihan();
        }
    }
    
    // ... (kod toggleNavButtons, logoutAdmin, form-login sedia ada) ...


    // ====================================================================
    // V. FUNGSI APLIKASI UTAMA
    // ====================================================================

    function muatkanAcaraPilihan() {
        const selects = ['jana-acara', 'kep-acara']; 
        // ‚ö†Ô∏è TUKAR ID ke checkbox (ISU 4)
        const checkboxDiv = document.getElementById('reg-acara-checkbox'); 
        
        if (document.getElementById('daftar').classList.contains('active')) {
            const selectedKategori = document.getElementById('reg-kategori').value;
            if (checkboxDiv) checkboxDiv.innerHTML = '';
            
            ACARA_SEMUA.forEach(acara => {
                if (isAcaraAvailable(acara, selectedKategori)) {
                    const input = document.createElement('input');
                    // ‚ö†Ô∏è TUKAR TYPE ke checkbox (ISU 4)
                    input.type = 'checkbox';
                    input.name = 'reg-acara';
                    input.value = acara;
                    input.id = `acara-${acara.replace(/\s/g, '-')}`;
                    input.onchange = toggleNamaInput; 

                    const span = document.createElement('span');
                    span.textContent = acara;

                    const label = document.createElement('label');
                    label.htmlFor = input.id;
                    label.appendChild(input);
                    label.appendChild(span);
                    if (checkboxDiv) checkboxDiv.appendChild(label);
                }
            });
            toggleNamaInput(); // Panggil untuk set input handler dan paparan medan
        }

        // 2. KEMASKINI: Handle Dropdown untuk Jana Acara dan Keputusan (kekal)
        selects.forEach(selectId => {
            // ... (kod sedia ada) ...
            const selectElement = document.getElementById(selectId);
            if (!selectElement) return;

            const currentValue = selectElement.value;
            
            let selectedKategori; 
            if (selectId.startsWith('jana')) {
                selectedKategori = document.getElementById('jana-kategori').value;
            } else if (selectId.startsWith('kep')) {
                selectedKategori = document.getElementById('kep-kategori').value;
            }
            
            selectElement.innerHTML = '';
            
            let firstAcara = '';
            ACARA_SEMUA.forEach(acara => {
                if (isAcaraAvailable(acara, selectedKategori)) {
                    const option = document.createElement('option');
                    option.value = acara;
                    option.textContent = acara;
                    selectElement.appendChild(option);
                    if (!firstAcara) firstAcara = acara;
                }
            });
            
            if ([...selectElement.options].some(opt => opt.value === currentValue)) {
                selectElement.value = currentValue;
            } else {
                selectElement.value = firstAcara;
            }
        });
    }

    function toggleNamaInput() {
        // ‚ö†Ô∏è Ambil semua nilai checkbox yang telah dipilih (ISU 4)
        const selectedCheckboxes = Array.from(document.querySelectorAll('input[name="reg-acara"]:checked'));
        const isRelaySelected = selectedCheckboxes.some(chk => chk.value === '4x100 meter');
        const isIndividualSelected = selectedCheckboxes.some(chk => ACARA_INDIVIDU.includes(chk.value));
        
        const divIndividu = document.getElementById('div-nama-individu');
        const divPasukan = document.getElementById('div-nama-pasukan');
        const inputNama = document.getElementById('reg-nama');
        const inputNoBadan = document.getElementById('reg-no-badan'); 
        const inputPasukan = document.querySelectorAll('.nama-pasukan');
        
        // Tetapkan event listener untuk huruf besar (untuk input baru/reset)
        if (inputNama) inputNama.oninput = toUpperCase;
        if (inputNoBadan) inputNoBadan.oninput = toUpperCase;
        inputPasukan.forEach(input => input.oninput = toUpperCase);

        if (isRelaySelected && isIndividualSelected) {
            // Jika kedua-dua dipilih (kita semak ralat pada submit) - Paparkan individu sahaja
            divIndividu.style.display = 'grid'; 
            divPasukan.style.display = 'none';
        } else if (isRelaySelected) {
            divIndividu.style.display = 'none';
            inputNama.required = false;
            if (inputNoBadan) inputNoBadan.required = false; 
            divPasukan.style.display = 'grid';
            inputPasukan.forEach(input => input.required = true);
        } else {
            divIndividu.style.display = 'grid'; 
            inputNama.required = true;
            if (inputNoBadan) inputNoBadan.required = true; 
            divPasukan.style.display = 'none';
            inputPasukan.forEach(input => input.required = false);
        }
    }

    // --- EVENT LISTENERS UNTUK CATEGORY CHANGE ---
    document.getElementById('reg-kategori').onchange = muatkanAcaraPilihan;
    document.getElementById('jana-kategori').onchange = muatkanAcaraPilihan; 
    document.getElementById('kep-kategori').onchange = muatkanAcaraPilihan; 

    // --- Halaman Daftar Acara (Firebase Write) ---
    document.getElementById('form-daftar-peserta').addEventListener('submit', function(e) {
        e.preventDefault();

        // ‚ö†Ô∏è BARU: Ambil semua acara yang dipilih (ISU 4)
        const selectedAcara = Array.from(document.querySelectorAll('input[name="reg-acara"]:checked')).map(chk => chk.value);
        if (selectedAcara.length === 0) { alert('Sila pilih sekurang-kurangnya satu Acara.'); return; }
        
        const kategori = document.getElementById('reg-kategori').value;
        const jantina = document.getElementById('reg-jantina').value;
        const rumah = document.getElementById('reg-rumah').value;

        const isRelaySelected = selectedAcara.includes('4x100 meter');
        const individualAcaraSelected = selectedAcara.filter(acara => ACARA_INDIVIDU.includes(acara));
        
        let peserta;
        let noBadan = '';
        
        // HAD PENDAFTARAN: Semak jika pendaftaran terlalu banyak
        if (individualAcaraSelected.length > 3) {
            alert('Had maksimum acara individu ialah 3. Sila batalkan pilihan.');
            return;
        }

        if (isRelaySelected) {
            // Logik Pendaftaran Relay
            const namaPasukan = Array.from(document.querySelectorAll('.nama-pasukan')).map(input => input.value.trim()).filter(n => n);
            if (namaPasukan.length !== 4) { alert('Sila masukkan nama 4 peserta untuk 4x100 meter.'); return; }
            peserta = namaPasukan.join(', ');

            // Semak duplikasi 4x100m 
            if (pendaftaran.some(p => p.acara === '4x100 meter' && p.kategori === kategori && p.jantina === jantina && p.rumah === rumah)) {
                 alert(`Rumah Sukan ${rumah} sudah didaftarkan untuk 4x100 meter ${kategori} ${jantina}.`);
                 return;
            }
        } 
        
        if (individualAcaraSelected.length > 0) {
            // Logik Pendaftaran Individu
            peserta = document.getElementById('reg-nama').value.trim();
            noBadan = document.getElementById('reg-no-badan').value.trim().toUpperCase(); 

            // Semak duplikasi No Badan (dalam kategori yang sama)
            if (pendaftaran.some(p => p.noBadan === noBadan && p.noBadan !== '' && p.kategori === kategori && individualAcaraSelected.includes(p.acara))) { 
                alert(`Nombor Badan ${noBadan} telah digunakan oleh peserta lain. Sila gunakan nombor lain.`);
                return;
            }
        }
        
        if (!isRelaySelected && individualAcaraSelected.length === 0) {
            alert('Sila pilih acara yang sah.');
            return;
        }

        // Simpan ke Firebase (Loop jika berbilang acara individu dipilih)
        showLoading();
        
        let promises = [];
        
        // Simpan Pendaftaran Individu
        individualAcaraSelected.forEach(acara => {
            const firebaseKey = dbRefPendaftaran.push().key; 
            const dataPeserta = { acara, kategori, jantina, rumah, peserta, noBadan: noBadan, id: firebaseKey }; 
            promises.push(dbRefPendaftaran.child(firebaseKey).set(dataPeserta));
        });
        
        // Simpan Pendaftaran Relay (jika ada)
        if (isRelaySelected) {
            const firebaseKey = dbRefPendaftaran.push().key; 
            const dataPasukan = { acara: '4x100 meter', kategori, jantina, rumah, peserta, noBadan: 'N/A', id: firebaseKey }; 
            promises.push(dbRefPendaftaran.child(firebaseKey).set(dataPasukan));
        }

        if (promises.length === 0) {
            hideLoading();
            alert('Tiada pendaftaran baru dibuat.');
            return;
        }
        
        Promise.all(promises)
            .then(() => {
                alert(`‚úÖ ${promises.length} pendaftaran berjaya disimpan ke Firebase!`);
                e.target.reset();
                hideLoading(); 
                muatkanAcaraPilihan(); 
            })
            .catch(error => {
                console.error("Ralat pendaftaran:", error);
                alert('Gagal mendaftar. Lihat konsol untuk ralat.');
                hideLoading();
            });
    });

    // ... (kod paparkanPendaftaran dan padamPeserta sedia ada) ...
    // ... (kod janaAcara dan paparkanJanaAcara sedia ada) ...


    // --- Halaman Keputusan (Firebase Read/Write) ---
    async function paparPesertaKeputusan() {
        if (!isAdmin) return alert("Akses Ditolak. Hanya Admin boleh memasukkan keputusan.");
        const acara = document.getElementById('kep-acara').value;
        const kategori = document.getElementById('kep-kategori').value;
        const jantina = document.getElementById('kep-jantina').value;
        const key = getUniqueKey(acara, kategori, jantina);

        if (!isAcaraAvailable(acara, kategori)) {
             alert(`Acara ${acara} tidak ditawarkan untuk ${kategori}.`);
             document.getElementById('form-masuk-keputusan').style.display = 'none';
             document.getElementById('kep-tajuk').textContent = '';
             return;
        }

        const pesertaDijana = acaraDijana[key];
        document.getElementById('kep-tajuk').textContent = `Input Keputusan: ${acara} ${kategori} ${jantina}`;
        document.getElementById('form-masuk-keputusan').style.display = 'none';
        
        if (!pesertaDijana || pesertaDijana.length === 0) {
            alert('Sila Jana Acara & Lorong di Halaman "Jana Acara & Lorong" dahulu.');
            return;
        }

        const isPadang = isAcaraPadang(acara);
        const unit = isPadang ? 'meter (m)' : 'saat (s)';

        const tbody = document.getElementById('table-masuk-keputusan').getElementsByTagName('tbody')[0];
        const thead = document.querySelector('#table-masuk-keputusan thead tr');
        tbody.innerHTML = '';
        
        // ‚ö†Ô∏è ISU 5: BORANG KHAS UNTUK ACARA PADANG
        if (isPadang) {
            let numPercubaan = 3; // Lontar Peluru, Lompat Jauh
            if (acara === 'Lompat Tinggi') {
                numPercubaan = 6; // Boleh diubah mengikut format sebenar
            }

            // HEADER JADUAL PADANG
            let headerHTML = '<th>Rumah Sukan</th><th>Peserta</th>';
            for (let i = 1; i <= numPercubaan; i++) {
                headerHTML += `<th>P${i}</th>`;
            }
            headerHTML += `<th>PB (${unit})</th><th>Kedudukan (1-6)</th>`;
            thead.innerHTML = headerHTML;
            
            pesertaDijana.sort((a, b) => a.slot - b.slot).forEach((p, index) => {
                const row = tbody.insertRow();
                row.dataset.key = key;
                row.dataset.rumah = p.rumah;
                row.dataset.id = p.id; 
                row.insertCell().textContent = p.rumah;
                row.insertCell().textContent = p.peserta;

                // Input Percubaan
                for (let i = 1; i <= numPercubaan; i++) {
                    const cell = row.insertCell();
                    const input = document.createElement('input');
                    input.type = 'number';
                    input.step = 'any';
                    input.name = `P${i}-${index}`;
                    cell.appendChild(input);
                }

                // Input Keputusan Terbaik (PB)
                const cellPB = row.insertCell();
                const inputPB = document.createElement('input');
                inputPB.type = 'number';
                inputPB.step = 'any';
                inputPB.name = `PB-${index}`;
                cellPB.appendChild(inputPB);
                
                // Input Kedudukan
                const cellKedudukan = row.insertCell();
                const inputKedudukan = document.createElement('select');
                inputKedudukan.name = `kedudukan-${index}`;
                inputKedudukan.innerHTML = '<option value="">-</option><option value="1">1 (6 M)</option><option value="2">2 (4 M)</option><option value="3">3 (3 M)</option><option value="4">4 (1 M)</option><option value="5">5 (1 M)</option><option value="6">6 (1 M)</option>';
                cellKedudukan.appendChild(inputKedudukan);

                // Pra-isi data (jika ada keputusan sedia ada)
                const resultExisting = keputusan.find(k => k.key === key);
                if (resultExisting) {
                    const pesertaResult = resultExisting.results.find(r => r.id === p.id);
                    if (pesertaResult) {
                        for (let i = 1; i <= numPercubaan; i++) {
                            row.querySelector(`input[name="P${i}-${index}"]`).value = pesertaResult[`P${i}`] || '';
                        }
                        inputPB.value = pesertaResult.keputusan;
                        inputKedudukan.value = pesertaResult.kedudukan.toString();
                    }
                }
            });

        } else {
            // ACARA BALAPAN (Sedia Ada)
            thead.innerHTML = '<th>Rumah Sukan</th><th>Peserta</th><th>Keputusan (<span id="unit-keputusan-balapan"></span>)</th><th>Kedudukan (1 - 6)</th>';
            document.getElementById('unit-keputusan-balapan').textContent = unit;
            
            pesertaDijana.sort((a, b) => a.slot - b.slot).forEach((p, index) => {
                const row = tbody.insertRow();
                row.dataset.key = key;
                row.dataset.rumah = p.rumah;
                row.dataset.id = p.id; 
                row.insertCell().textContent = p.rumah;
                row.insertCell().textContent = p.peserta;
                
                const cellKeputusan = row.insertCell();
                const inputKeputusan = document.createElement('input');
                inputKeputusan.type = 'number';
                inputKeputusan.step = 'any';
                inputKeputusan.name = `keputusan-${index}`;
                inputKeputusan.required = false; // Tidak wajib isi jika tidak ada kedudukan
                cellKeputusan.appendChild(inputKeputusan);
                
                const cellKedudukan = row.insertCell();
                const inputKedudukan = document.createElement('select');
                inputKedudukan.name = `kedudukan-${index}`;
                inputKedudukan.innerHTML = '<option value="">-</option><option value="1">1 (6 M)</option><option value="2">2 (4 M)</option><option value="3">3 (3 M)</option><option value="4">4 (1 M)</option><option value="5">5 (1 M)</option><option value="6">6 (1 M)</option>';
                cellKedudukan.appendChild(inputKedudukan);

                const resultExisting = keputusan.find(k => k.key === key);
                if (resultExisting) {
                    const pesertaResult = resultExisting.results.find(r => r.id === p.id);
                    if (pesertaResult) {
                        inputKeputusan.value = pesertaResult.keputusan;
                        inputKedudukan.value = pesertaResult.kedudukan.toString();
                    }
                }
            });
        }
        document.getElementById('form-masuk-keputusan').style.display = 'block';
    }

    // --- SUBMIT KEPUTUSAN (Diperbaiki untuk Padang) ---
    document.getElementById('form-masuk-keputusan').addEventListener('submit', function(e) {
        if (!isAdmin) return alert("Akses Ditolak. Hanya Admin boleh menyimpan keputusan.");
        e.preventDefault();
        
        const tbody = document.getElementById('table-masuk-keputusan').getElementsByTagName('tbody')[0];
        const rows = Array.from(tbody.rows);
        const key = rows[0].dataset.key;
        const [acara, kategori, jantina] = key.split('|').map(s => s.replace(/_/g, ' ')); 
        const isPadang = isAcaraPadang(acara);

        let results = [];
        let kedudukanUsed = [];

        rows.forEach((row, index) => {
            const rumah = row.dataset.rumah;
            const peserta = row.cells[1].textContent;
            const id = row.dataset.id; 
            let resultEntry = { id, rumah, peserta };
            let kedudukanVal = 0;
            let keputusanVal = 0;
            
            if (isPadang) {
                // LOGIK SIMPAN KEPUTUSAN ACARA PADANG (ISU 5)
                const numPercubaan = (acara === 'Lompat Tinggi') ? 6 : 3;
                
                const inputKedudukan = row.querySelector(`select[name="kedudukan-${index}"]`);
                const inputPB = row.querySelector(`input[name="PB-${index}"]`);
                
                kedudukanVal = inputKedudukan.value ? parseInt(inputKedudukan.value) : 0;
                keputusanVal = inputPB.value ? parseFloat(inputPB.value) : 0;
                
                // Kumpulkan data percubaan
                for (let i = 1; i <= numPercubaan; i++) {
                    const inputP = row.querySelector(`input[name="P${i}-${index}"]`);
                    resultEntry[`P${i}`] = inputP.value ? parseFloat(inputP.value) : null;
                }
                
                // Semak Kedudukan Duplikasi
                if (kedudukanVal && kedudukanUsed.includes(kedudukanVal)) {
                    alert(`Kedudukan ${kedudukanVal} telah diberikan lebih daripada sekali. Sila betulkan.`);
                    e.preventDefault();
                    return;
                }
                if (kedudukanVal) kedudukanUsed.push(kedudukanVal);
                
            } else {
                // LOGIK SIMPAN KEPUTUSAN ACARA BALAPAN (Sedia Ada)
                const inputKedudukan = row.querySelector(`select[name="kedudukan-${index}"]`);
                const inputKeputusan = row.querySelector(`input[name="keputusan-${index}"]`);
                
                kedudukanVal = inputKedudukan.value ? parseInt(inputKedudukan.value) : 0;
                keputusanVal = inputKeputusan.value ? parseFloat(inputKeputusan.value) : 0;

                // Semak Kedudukan Duplikasi
                if (kedudukanVal && kedudukanUsed.includes(kedudukanVal)) {
                    alert(`Kedudukan ${kedudukanVal} telah diberikan lebih daripada sekali. Sila betulkan.`);
                    e.preventDefault();
                    return;
                }
                if (kedudukanVal) kedudukanUsed.push(kedudukanVal);
            }

            // Simpan hasil akhir (terpakai untuk Balapan dan Padang)
            resultEntry.kedudukan = kedudukanVal;
            resultEntry.keputusan = keputusanVal; // Guna Keputusan Terbaik (PB) untuk Padang
            resultEntry.mata = kedudukanVal ? MATA[kedudukanVal] : 0;
            
            results.push(resultEntry);
        });

        const resultData = {
            key, acara, kategori, jantina,
            results: results.sort((a, b) => a.kedudukan - b.kedudukan)
        };
        
        dbRefKeputusan.child(key).set(resultData)
            .then(() => {
                alert('Keputusan dan mata telah dikira dan disimpan ke Firebase!');
                document.getElementById('form-masuk-keputusan').style.display = 'none';
                document.getElementById('kep-tajuk').textContent = '';
            })
            .catch(error => {
                console.error("Ralat Simpan Keputusan:", error);
                alert('Gagal menyimpan keputusan. Lihat konsol untuk ralat.');
            });
    });

    // FUNGSI PAPARKAN KEPUTUSAN DISIMPAN (Diperbaiki untuk mengisi 2 jadual - ISU 3)
    function paparkanKeputusanDisimpan() {
        const tbodyKeputusan = document.getElementById('table-keputusan-disimpan').getElementsByTagName('tbody')[0];
        // ‚ö†Ô∏è Tambah rujukan kepada jadual di halaman Analisis (ISU 3)
        const tbodyAnalisis = document.getElementById('table-keputusan-pemenang-analisis') ? document.getElementById('table-keputusan-pemenang-analisis').getElementsByTagName('tbody')[0] : null;

        tbodyKeputusan.innerHTML = '';
        if (tbodyAnalisis) tbodyAnalisis.innerHTML = ''; // Kosongkan juga tbody Analisis
        
        // Susun Keputusan mengikut Acara, Kategori, Jantina
        const keputusanTersusun = [...keputusan].sort((a, b) => {
            if (a.acara !== b.acara) return a.acara.localeCompare(b.acara);
            const kategoriA = KATEGORI.indexOf(a.kategori);
            const kategoriB = KATEGORI.indexOf(b.kategori);
            if (kategoriA !== kategoriB) return kategoriA - kategoriB;
            return a.jantina.localeCompare(b.jantina);
        });

        keputusanTersusun.forEach(k => {
            const juara = k.results.find(r => r.kedudukan === 1);
            const kedua = k.results.find(r => r.kedudukan === 2);
            const ketiga = k.results.find(r => r.kedudukan === 3);

            // Masukkan ke jadual di halaman Keputusan
            const rowKeputusan = tbodyKeputusan.insertRow();
            rowKeputusan.insertCell().textContent = k.acara;
            rowKeputusan.insertCell().textContent = k.kategori;
            rowKeputusan.insertCell().textContent = k.jantina;
            rowKeputusan.insertCell().textContent = juara ? `${juara.rumah} (${juara.peserta.substring(0, 10)}...)` : '-';
            rowKeputusan.insertCell().textContent = kedua ? `${kedua.rumah} (${kedua.peserta.substring(0, 10)}...)` : '-';
            rowKeputusan.insertCell().textContent = ketiga ? `${ketiga.rumah} (${ketiga.peserta.substring(0, 10)}...)` : '-';


            // ‚ö†Ô∏è Masukkan juga ke jadual di halaman Analisis (ISU 3)
            if (tbodyAnalisis) {
                const rowAnalisis = tbodyAnalisis.insertRow();
                rowAnalisis.insertCell().textContent = k.acara;
                rowAnalisis.insertCell().textContent = k.kategori;
                rowAnalisis.insertCell().textContent = k.jantina;
                rowAnalisis.insertCell().textContent = juara ? `${juara.rumah} (${juara.peserta.substring(0, 10)}...)` : '-';
                rowAnalisis.insertCell().textContent = kedua ? `${kedua.rumah} (${kedua.peserta.substring(0, 10)}...)` : '-';
                rowAnalisis.insertCell().textContent = ketiga ? `${ketiga.rumah} (${ketiga.peserta.substring(0, 10)}...)` : '-';
            }
        });
    }
    
    // FUNGSI ANALISIS (Sedia Ada, cuma memastikan panggilan paparkanKeputusanDisimpan)
    function kiraAnalisis() {
        let markahRumah = { "Merah": 0, "Biru": 0, "Kuning": 0 };
        let pecahanAcara = {}; 

        // ... (kod kiraan markah sedia ada) ...
        keputusan.forEach(k => {
            const key = k.key;
            pecahanAcara[key] = {
                Merah: 0, Biru: 0, Kuning: 0,
                acara: k.acara, kategori: k.kategori, jantina: k.jantina
            };

            k.results.forEach(r => {
                if (r.kedudukan >= 1 && r.kedudukan <= 6) { 
                    markahRumah[r.rumah] += r.mata;
                    pecahanAcara[key][r.rumah] += r.mata;
                }
            });
        });

        document.getElementById('score-merah').querySelector('.total-points').textContent = markahRumah.Merah;
        document.getElementById('score-biru').querySelector('.total-points').textContent = markahRumah.Biru;
        document.getElementById('score-kuning').querySelector('.total-points').textContent = markahRumah.Kuning;

        // ... (kod paparan pecahan markah sedia ada) ...
        const pecahanDiv = document.getElementById('pecahan-markah');
        pecahanDiv.innerHTML = '';
        
        const keysSorted = Object.keys(pecahanAcara).sort((a, b) => {
            const dataA = pecahanAcara[a];
            const dataB = pecahanAcara[b];
            
            if (dataA.acara !== dataB.acara) return dataA.acara.localeCompare(dataB.acara);
            const kategoriA = KATEGORI.indexOf(dataA.kategori);
            const kategoriB = KATEGORI.indexOf(dataB.kategori);
            if (kategoriA !== kategoriB) return kategoriA - kategoriB;
            return dataA.jantina.localeCompare(dataB.jantina);
        });

        keysSorted.forEach(key => {
            const data = pecahanAcara[key];
            const eventDiv = document.createElement('div');
            eventDiv.className = 'event-card';
            eventDiv.innerHTML = `
                <h4>${data.acara} - ${data.kategori} ${data.jantina}</h4>
                <p>
                    <span class="merah" style="padding: 2px 5px; border-radius: 3px;">Merah: <b>${data.Merah}</b> mata</span> |
                    <span class="biru" style="padding: 2px 5px; border-radius: 3px;">Biru: <b>${data.Biru}</b> mata</span> |
                    <span class="kuning" style="padding: 2px 5px; border-radius: 3px;">Kuning: <b>${data.Kuning}</b> mata</span>
                </p>
            `;
            pecahanDiv.appendChild(eventDiv);
        });
        
        // Panggil untuk mengisi jadual pemenang di halaman analisis
        paparkanKeputusanDisimpan(); 
    }

    // --- Inisialisasi Aplikasi ---
    document.addEventListener('DOMContentLoaded', () => {
        muatkanAcaraPilihan(); 
    });

</script>

</body>
</html>
